YUI.add("mail-model-convstore",function(e){function y(t){try{e.fire.apply(e,t)}catch(n){typeof globals!="undefined"&&globals.report?globals.report("caughterror:..-build-mail-model-convstore:1",n,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-mail-model-convstore:1"),e.use("common-utils-error",function(){var e=t[1]&&h.isString(t[1])?t[1]:"";p.error.report("convstore error for "+t[0]+e,n,1,1,1)})}}function b(t){m.getBuilder||(m.getBuilder=e.mail&&e.mail.controller&&e.mail.controller.v3&&e.mail.controller.v3.converter&&e.mail.controller.v3.converter.getParticipantListBuilder),m._toV3MsgHdr||(m._toV3MsgHdr=function(e){var t=e&&(e.header&&e.header.from||e.from);return{headers:{from:[{email:t&&t.email,name:t&&t.name}]}}}),m._getMsgAtIndexFromConv||(m._getMsgAtIndexFromConv=function(e,n){return e&&e.midMap&&e.midMap[n]&&t.get(e.midMap[n].fid,e.midMap[n].mid)})}e.namespace("mail.model");var t="ds:conv:",n="ds:msg:",r="change",i="refresh",s="remove",o="reg",u="unreg",a="Trash",f="%40B%40Bulk",l="invalidarg",c=e.mail,h=e.Lang,p=e.common.Utils,d=1e4,v=c.model.ConvStore={},m={getBuilder:null,_toV3MsgHdr:null,_getMsgAtIndexFromConv:null},g=e.mail.ui.FolderUtils;e.mix(v,{Conversations:function(){function N(e,t){return C(e,t)}function C(e,t){return k(t)[z(e)]}function k(e){var t=e===a?e:"Norm";return v[t]=v[t]||{},v[t]}function L(e,t,n){var r,i,s,o,u,a,f;if(!(u=C(t,e)))return null;if(n&&u){a=S.olist;for(s=0;s<a.length;s++)if(a[s].cid===t){o=a.splice(s,1),a.push(o[0]);break}}f=p.wcopy(u);if(f.sparse)return f;f.msgs=[],G();for(s=0;s<f.midMap.length;s++){r=T.get(f.midMap[s].fid,f.midMap[s].mid);if(!r)return null;i=r.header?T.toMessageInfo(f.midMap[s].fid,r):r,f.msgs.push(i)}return f}function A(e,t,n){var r={messageInfo:e.messageInfo,folder:{folderInfo:{fid:t}},conversation:{cid:e.cid,summary:e.summary}};M(r,n)}function O(e){var t;t=z(e.cid),k(e.fid)[t]=e,w[t]={fid:e.fid}}function M(e,n){function x(e,t){var n=0,r,i,s,o,u;u=e.fid,o=S.olist,s=N()+t;while(n<o.length&&s>S.maxmsgs)E[z(o[n].cid)]?n++:(r=o.splice(n,1),r[0].cid!==e.cid&&(i=R(r[0].cid,r[0].fid,!0),i&&(s-=i.midMap.length)));o.push({fid:e.fid,cid:e.cid})}function N(){var e,t,n=0;for(t in v)for(e in v[t])v[t][e].sparse||(n+=v[t][e].midMap.length);return n}function C(e,t){var n,r,i=e.messageInfo,s=e.folder.folderInfo.fid,o=U(s,e.conversation,i[0]);o.reqTime=t,o.midMap=[],x(o,i.length);for(r=0;r<i.length;r++)n=i[r],o.midMap.push({mid:n.mid,fid:q(n,s)}),_(n,o);return O(o),$(o),o}var r=h.isArray(e),s=r?e:[e],o=e.fireEvent===!1?!1:!0,u=[],a,f,l,c,d,m,g,b,w;G();for(l=0;l<s.length;l++){c=s[l],a=B(c.folder.folderInfo.fid,c.conversation.cid);if(a)for(d=0;d<a.midMap.length;d++){m=a.midMap[d],w=T.get(m.fid,m.mid);if(w){for(g=0;g<c.messageInfo.length;g++){b=c.messageInfo[g];if(b.mid===m.mid)break}(g>=c.messageInfo.length||q(b,c.folder.folderInfo.fid)!==m.fid)&&T.removeConvMsg(m.fid,m.mid,!1)}}f=C(s[l],n),u.push(p.wcopy(f))}u.length&&o&&y([t+i,"lmt",null,u])}function _(e,t){F(e,t.cid),I(e,q(e,t.fid)),T.syncConvHeader(q(e,t.fid),e)}function D(e,t){var n=t.conversation,r=n.recentMsg?n.recentMsg:n.messageInfo[0],i=U(e,n,r);return F(r,i.cid),i.msgs=[p.wcopyWrapper(r)],i}function P(e,t){var n,r,i,s,o=p.wcopy(t);o.msgs=[],o.anchorDate=null,G();for(n=0;n<t.midMap.length;n++){s=t.midMap[n].fid===e,r=T.get(t.midMap[n].fid,t.midMap[n].mid);if(!r)break;i=r.header?T.toMessageInfo(t.midMap[n].fid,r):p.wcopy(r),i.fid||(i.fid=t.midMap[n].fid),o.msgs.push(i);if(s&&!o.anchorDate||g.isDraftFid(e))o.anchorDate=i.receivedDate}return o.midMap=null,o}function H(e,t){var n;for(n=0;n<t.messageInfo.length;n++)if(t.messageInfo[n].sourceFolderInfo.fid===e)return t.messageInfo[n].receivedDate;return null}function B(n,r){var i=h.isString(r)||!r?r:r.cid,s,o,u;(!n||!i)&&e.error(t+"get:"+l),G(),s=C(i,n);if(s&&!s.sparse){for(o=0;o<s.midMap.length;o++){u=T.get(s.midMap[o].fid,s.midMap[o].mid);if(!u)return!1}return s}return!1}function j(e,t){var n,r,i;G();if((r=T.get(e,t))&&r.cid&&(i=B(e,r.cid)))for(n=0;n<i.midMap.length;n++)if(T.getPermMidPart(i.midMap[n].mid)===T.getPermMidPart(r.mid))return i;return null}function F(e,t){e.cid=t}function I(e,t){e.fid=t}function q(e,t){return e.fid||(e.folderInfo&&e.folderInfo.fid?e.folderInfo.fid:e.sourceFolderInfo&&e.sourceFolderInfo.fid?e.sourceFolderInfo.fid:t)}function R(e,t,n){var r,i=C(e,t);if(i){if(!i.sparse)for(r=0;r<i.midMap.length;r++)T.removeConvMsg(i.midMap[r].fid,i.midMap[r].mid,n);delete k(t)[z(e)]}return i}function U(t,n,r){var i={cid:n.cid||"",fid:t,snapshotTime:r.receivedDate,checksum:n.summary.checksum,totalMsgs:n.summary.totalMsgs,totalUnread:n.summary.unreadMsgs,totalFlagged:n.summary.flaggedMsgs,totalDraft:n.summary.hasDraft?1:0,totalHasAttach:n.summary.hasAttachment?1:0,totalHasCoupon:n.summary.hasCoupon?1:0,subject:n.summary.totalMsgs>1?n.summary.subject:r.subject,subjectDir:n.summary.totalMsgs>1?n.summary.subjectDir:r.subjectDir,anchorDate:n.summary.iDate,recipients:n.summary.participantList,msgCountsByFolder:n.summary.msgCountsByFolder,flags:r.flags?e.clone(r.flags):{},recentmid:r.mid,snippet:r.snippet,receivedDate:r.receivedDate,classification:r.classification};return i}function z(e){var t;return h.isString(e)?(t=e.lastIndexOf("_"),t++):t=-1,t<0?e:e.substr(t)}function W(e,t){return e===a?t===a:t!==a}function X(e,t){return e&&t&&z(e.cid)===z(t.cid)&&W(e.fid,t.fid)}function V(e,t){return!e||!t||g.isDraftFid(t)?!1:NeoConfig.hasConvV3?!0:e.totalMsgs===1?!0:t==="Sent"?!1:e.totalUnread===0&&e.msgs&&(e.msgs[0].fid&&!g.isDraftFid(e.msgs[0].fid)||e.msgs[0].sourceFolderInfo&&!g.isDraftFid(e.msgs[0].sourceFolderInfo.fid))?!0:!1}function $(t){function f(n,r,i,s){var o,f;o=T.get(i,s),a&&a.nextMsg(u._toV3MsgHdr(o));if(!o){e.common.Utils.log({m:"msgInfo is undefined",cid:t.cid,msgfid:i,msgmid:s},!0,"UndefinedObject");return}f=o.flags,ut(n.msgCountsByFolder,f.isRead,i),n.totalUnread+=f.isRead?0:1,n.totalFlagged+=f.isFlagged?f.isFlagged:0,n.totalDraft+=g.isDraftFid(q(o,r))?1:0,n.totalHasAttach+=f.hasAttachment?f.hasAttachment
:0,n.totalHasCoupon+=f.hasCoupon?f.hasCoupon:0}var n,r,i,s,o,u=m,a=null;b(T),t.totalMsgs=t.midMap.length,t.recentmid=t.totalMsgs?t.midMap[0].mid:"",i={totalUnread:0,totalFlagged:0,totalDraft:0,totalHasAttach:0,totalHasCoupon:0,msgCountsByFolder:[]},u.getBuilder&&(s=u._toV3MsgHdr(u._getMsgAtIndexFromConv(t,0)),o=u._toV3MsgHdr(u._getMsgAtIndexFromConv(t,t.totalMsgs-1)),a=u.getBuilder(s,o));for(n=0;n<t.totalMsgs;n++)f(i,t.fid,t.midMap[n].fid,t.midMap[n].mid);a&&(i.recipients=a.getParticipants()),y(["ConvStore:calcConvSummary",t,i]);for(r in i)t[r]=i[r];return t}function J(e,t,n,r,i,s,o,u){var a,f,l;G();for(var c in t)c&&(a=C(c,n))?(f=p.wcopy(a),u&&u.func&&(l=u.func(f,u.args)),$(f),k(n)[z(c)]=f):f=a={cid:c,sparse:!0,moved:!0},i.push(p.wcopy(f)),r.push(a),s.push(p.diff(f,a)),o&&o.push(l)}function K(e,n,i,s){function g(t,n){var r,i,s,f,l;for(i=0;i<n.data.length;i++){f=n.data[i],l=q(f,t.fid);for(r=t.midMap.length-1;r>=0;r--){s=T.get(t.midMap[r].fid,t.midMap[r].mid);if(s){u=s.receivedDate||s.header&&s.header.receivedDate;if(u>=f.receivedDate)break}}o=T.get(l,f.mid),t.midMap.splice(r+1,0,{mid:f.mid,fid:l}),o?T.syncConvInfo(l,{mid:f.mid,cid:e,newmsg:f}):_(f,t)}return a}var o,u,a=h.isArray(i)?i:[i],f=n?"Trash":"Inbox",l=[],c=[],p=[],d=[],v={},m="msg:add";G(),v[e]=1,J(m,v,f,c,l,p,d,{func:g,args:{data:a}}),s&&(s.cachedMsg=o),y([t+r,m,c,l,p,d,s])}function Q(){v={},w={},E={},S={olist:[],maxmsgs:d,sync:{}},T=null}function G(){T||(T=c.model.DataStore.Messages,T.setConvStore(c.model.ConvStore.Conversations))}function Z(e,n,i,s,o,u,l){var c,h=i?i.length:0,p,d={},v=u||"",m=[],g=[],b=[],w={},E="msg:"+o;w.fid=e,w.srcFid=v,w.mids=[];if(o.indexOf("conv_")===0)return;for(c=0;c<h;c++)o==="move"&&v!==a&&v!==f&&e!==a&&e!==f&&R(i[c].cid,i[c].fid,!1),i[c].cid&&(p=i[c].cid,d[p]||(d[p]=1),w.mids[c]=i[c].mid);w=e===v?{}:w,J(E,d,e,g,m,b),l&&l.fromSearch&&(w.fromSearch=l.fromSearch),l&&l.fromConv&&(w.fromConv=l.fromConv),y([t+r,E,g,m,b,w])}function et(e,n,i,s,o){function b(e,t){var n,r;for(n=0;n<t.data.length;n++)for(r=0;r<e.midMap.length;r++)if(e.midMap[r].mid===t.data[n].mid){e.midMap.splice(r,1);break}}var u,l,c="msg:remove",p=h.isArray(n)?n:[n],d={},v=[],m=[],g=[];if(!i&&s&&s!==a&&s!==f&&e!==a&&e!==f)return;G();for(u=0;u<p.length;u++)l=p[u].cid,d[l]||(d[l]=1);J(c,d,e,m,v,g,null,{func:b,args:{data:p}}),y([t+r,c,m,v,g,o])}function tt(e){var t=z(e);E[t]||(E[t]=0),E[t]++}function nt(t){var n=z(t);e.Lang.isUndefined(E[n])||(E[n]--,E[n]<=0&&delete E[n])}function rt(n,r){var s,o,u;for(s=0;s<n.length;s++)o=z(n[s].cid),!e.Lang.isUndefined(E[o])&&E[o]>0&&(u=u||{},u[o]=n[s]);u&&y([t+i,"lft",r,u])}function it(e,t){var n=0;if(e.msgs){for(n=0;n<e.msgs.length;n++)if(e.msgs[n].flags.isRead!==t.isRead)return!1;return!0}return e.flags?e.flags.isRead===t.isRead:!1}function st(n,i,s,o){var u,a,f,l,c=s.flags,d,v,m,g=[],b=[],w=[],E=c.isRead!==undefined;h.isArray(i)||(i=[i]),G();for(d=0;d<i.length;d++){u=i[d];if(u.cid&&(a=B(n,u.cid))){for(v=0;v<a.midMap.length;v++)T.update(a.midMap[v].fid,{mid:a.midMap[v].mid},s,o);m={},m[u.cid]=1,J(o,m,n,g,w,b)}else{if(E&&it(u,c))continue;a=u,f=p.wcopy(u),f.msgCountsByFolder&&(f.msgCountsByFolder[0].fid=f.msgCountsByFolder[0].fid==="Bulk%20Mail"&&f.flags&&f.flags.isSpam?"%40B%40Bulk":f.msgCountsByFolder[0].fid),e.Lang.isUndefined(c.isFlagged)||(f.totalFlagged=c.isFlagged?f.totalMsgs:0),e.Lang.isUndefined(c.isRead)||(f.totalUnread=c.isRead?0:f.totalMsgs,ot(f.msgCountsByFolder,c.isRead)),f.sparse=1,l={},T.applyDiff(l,u.msgs[0],s),f.msgs=[l],O(f),w.push(p.wcopy(f)),g.push(a),b.push(p.diff(f,a))}}g.length&&y([t+r,o,g,w,b,undefined,s])}function ot(e,t){var n;if(e)for(n=0;n<e.length;n++)t?e[n].unread=0:e[n].unread=e[n].total}function ut(e,t,n){var r,i=-1;for(r=0;r<e.length;r++)e[r].fid===n&&(i=r);i===-1&&(i=e.length,e.push({fid:n,total:0,unread:0})),e[i].total+=1,e[i].unread+=t?0:1}function at(e,n,i,s,o){var u,a,l,c,h,d=[],v=[],m=[],b=0;while(u=i[b++])a=p.wcopy(x[u]||{cid:u,fid:e}),x[u]&&(x[u]={receivedDate:x[u].receivedDate,fid:x[u].fid,movedAt:x[u].movedAt}),a.msgs&&(a.msgs.splice(1,a.msgs.length-1),c=q(a.msgs[0],e)),l=p.wcopy(a),l.fid=n,l.sparse=1,l.msgs&&(h=!g.isDraftFid(c)&&!g.isSentFid(c)?n:c,l.msgs[0].folderInfo={fid:h,name:h},l.msgs[0].sourceFolderInfo={fid:h,name:h}),n!==f&&R(u,n,!1),d.push(a),v.push(l),m.push(p.diff(l,a));d.length&&y([t+r,o,d,v,m])}function ft(n,r,i){var o,u,a,f,c,d=[],v=S.olist,m=Date.now(),g=!i;h.isArray(r)||(r=[r]),G(),n||e.error(t+"remove:"+l);for(o=0;o<r.length;o++){a=r[o];if(!a||!a.cid)continue;f=R(a.cid,n,!1);for(u=0;u<v.length;u++)if(v[u].cid===a.cid){v.splice(u,1);break}a&&!a.fid&&(a.fid=n),c=p.wcopy(a),x[a.cid]=c,x[a.cid].fid=n,x[a.cid].movedAt=m,d.push(c)}y([t+s,n,d.length&&d,g,i])}function lt(e){if(!e){x={};return}e=h.isArray(e)?e:[];for(var t=0;t<e.length;t++)delete x[e[t].cid]}function ct(e,t){return e.receivedDate>t.receivedDate}function ht(e,t){return e.totalUnread===t.totalUnread&&e.totalMsgs===t.totalMsgs&&e.totalFlagged===t.totalFlagged&&e.totalDraft===t.totalDraft&&e.receivedDate===t.receivedDate&&p.congruent(e.msgCountsByFolder,t.msgCountsByFolder)?!0:!1}function pt(t){return!e.Lang.isUndefined(E[t])&&E[t]>0}function dt(e){var t=x[e.cid];return t&&t.fid===e.fid&&t.receivedDate===e.receivedDate?t:null}function vt(e,t,n){var r=k(t)[e];return r?(r.checksum=n,!0):!1}var v={},w={},E={},S={olist:[],maxmsgs:d,sync:{}},x={},T=null;return e.on(n+r,Z),e.on(n+s,et),e.on(t+o,tt),e.on(t+u,nt),{set:M,get:L,getCache:k,setPrefetch:A,getPermCidPart:z,areSameConvs:X,canConvOverlapInFids:W,toConvInfo:D,toConvInfoEvent:P,getAnchorDate:H,isConvLocked:pt,isConvRemoved:dt,updateChecksum:vt,compareConvSummaries:ht,areNewMsgsAdded:ct,removeFromCache:R,removeFromMovingCache:lt,canBatchLMTGDM:V,threadUpdate:rt,msgAdd:K,update:st,move:at,remove:ft,calcConvSummary:$,getParam:function(e){return w[z(e)]},isCached:B,midToConv:j,hit:N,cacheSize:function(e){!isNaN(e)&&e>0&&(S.maxmsgs=e)},olist:function(){return S.olist},flush:Q,_msgCntConv:ot,_msgCntMsg:ut,_isFlagMatch:it}}()})},"1.0.0",{requires:["common-utils"
,"mail-ui-folder-utils","mail-common-utils-features"]});
YUI.add("mail-api-message-selector",function(e){"use strict";var t,n=e.Mail.Api.BaseSelector,r=e.Mail.Api.Validator,i=e.mix,s=e.Lang,o=["image","attachment"],u=["attachment","read","unread","flagged","starred","cardConversationId"],a=["TRASH","BULK","SYNC","INVISIBLE"],f=["TRASH","DRAFT","SENT","INBOX","BULK","USER","SYNC","INVISIBLE","ARCHIVE"],l=["date","subject","sender","relevance","to","recipient","attachment","flagged","unread"],c=["personal","financial","social","travel"];t=function(n){function w(e,t){b[e]=t}function E(e,t){var n=[];b[e]?(s.isArray(b[e])?n=b[e]:n.push(b[e]),n.push(t),w(e,n)):w(e,t)}function S(e){if(b.has)throw new Error("has is already set to "+b.has);r.oneOf("has",e,o),w("has",e)}function x(){w("timezone",y)}function T(){var t=[];return e.Object.each(b,function(n,r){e.Lang.isArray(n)?e.Array.each(n,function(e){t.push(r+":"+e)}):t.push(r+":"+n)}),t.join(" ")}function N(){var e,t=["groupBy","timezone","sort","is"],n=["in","folderId"],r=!1;for(e in b){if(!b.hasOwnProperty(e)||t.indexOf(e)>=0)continue;if(n.indexOf(e)>=0){r=!0;continue}return!1}return r}var h=this,p=!1,d=!1,v="",m=!1,g,y,b;n=n||{},g=n.mailboxId||NeoConfig.V3MailboxId,y=n.timeZone||NeoConfig.clientTimeZone,b={},i(h,{typeName:"messages",_isQueryFulfilled:function(){var e=!1,t=["groupBy","timezone","sort","acctId"],n;for(n in b)if(b.hasOwnProperty(n)&&b[n]!==null&&t.indexOf(n)===-1){e=!0;break}return p?!0:e},fetchV2Mid:function(){return m=!0,h},id:function(t){var n;return r.isArray("mids",t),r.isEmpty("mids",t),t=e.Array.dedupe(t),n=e.Array.map(t,function(e){return e.replace(/\+/g,"-").replace(/\//g,"_")}).join(" "),w("id","("+n+")"),h},conversationId:function(t){return h.typeName="conversations",r.isArray("conversationId",t),r.isEmpty("conversationId",t),t=e.Array.dedupe(t),w("conversationId","("+t.join(" ")+")"),h},cardConversationId:function(t){return h.typeName="cardConversations",r.isArray("cardConversationId",t),r.isEmpty("cardConversationId",t),t=e.Array.dedupe(t),w("cardConversationId","("+t.join(" ")+")"),h},decoId:function(t){return h.typeName="conversations",r.isArray("decoId",t),r.isEmpty("decoId",t),t=e.Array.dedupe(t),w("decoId","("+t.join(" ")+")"),h},messageType:function(e){var t;return r.oneOf("folderType",e,f),t=a.indexOf(e)>=0,t?h.folderType(e):a.forEach(function(e){h.notFolderType(e)}),h},folderId:function(e){return r.isEmpty("folderId",e),w("folderId",e),h},folderType:function(e){return r.oneOf("folderType",e,f),E("folderType",e),h},notFolderType:function(e){return r.oneOf("notFolderType",e,f),E("-folderType",e),h},acctId:function(e){return w("acctId",e),h},isRead:function(){return w("is","read"),h},isUnread:function(){return w("is","unread"),h},isStarred:function(){return w("is","flagged"),h},inInbox:function(){return w("in","Inbox"),h},inArchive:function(){return w("in","Archive"),h},inDraft:function(){return w("in","Draft"),h},inSent:function(){return w("in","Sent"),h},queryToken:function(e){return r.isString("queryToken",e),w("queryToken",e),h},hasImage:function(){return S("image"),h},hasAttachment:function(){return S("attachment"),h},mail:{category:function(e){return r.oneOf("category",e,c),w("category",e),h},size:function(e){return r.isInteger("size",e),w("size",e*1),h},subject:function(e){return r.isString("subject",e),w("subject",e),h},body:function(e){return r.isString("body",e),w("body",e),h},attachmentCount:function(e){return r.isInteger("attachmentCount",e),w("attachmentCount",e*1),h},attachmentType:function(e){return w("attachmentType",e),h},content:function(e){return w("content",e),h}},userQuery:function(e){return typeof e=="string"&&(e='"'+e.replace(/"/g,'\\"')+'"'),w("userQuery",e),h},person:{fromName:function(e){return r.isString("from",e),w("from",e),h},toName:function(e){return r.isString("to",e),w("to",e),h},ccName:function(e){return r.isString("cc",e),w("cc",e),h},toEmail:function(e){return r.isEmail("toEmail",e),w("toEmail",e),h},fromEmail:function(e){return r.isEmail("fromEmail",e),E("fromEmail",e),h}},time:{on:function(e){return r.isString("on",e),r.isStringDate("on",e),x(),w("on",e),h},after:function(e){return r.isString("after",e),r.isStringDate("after",e),x(),w("after",e),h},before:function(e){return r.isString("before",e),r.isStringDate("before",e),x(),w("before",e),h},year:function(e){return r.isInteger("year",e),w("year",e*1),x(),h},month:function(e){return r.isInteger("month",e),w("month",e*1),x(),h},day:function(e){return r.isInteger("day",e),w("day",e*1),x(),h}},page:{count:function(e){return r.isInteger("count",e),w("count",e*1),h},offset:function(e){return r.isInteger("offset",e),w("offset",e*1),h},sortBy:function(e){var t=e;r.isString("sortBy",e);if(e[0]==="+"||e[0]==="-")t=t.substr(1);return r.oneOf("sortBy",t,l),w("sort","("+e+")"),h}},includeSoftDeleted:function(){return w("include","softdeleted"),h},groupBy:function(e){return r.oneOf("groupBy",e,u),w("groupBy",e),h},groupByConversation:function(){return d=!0,this.typeName="conversations",w("groupBy","conversationId"),h},raw:function(e){return r.isString("raw",e),p=!0,v=e,h},isBulkOperation:function(){return typeof n.isBulkOperation!="undefined"?n.isBulkOperation:N()},serializeQuery:function(){return T()},serialize:function(){var e="/ws/v3/mailboxes/@.id=="+h._urlEscape(g)+"/messages/@.select==q",t={q:p?v:T()};return h.isBulkOperation()&&(t.async="true"),m&&(t.oldSearchV2Mids="1"),e+"?"+h._queryStringify(t)}}),t.superclass.constructor.call(this,n)},e.extend(t,n),e.namespace("Mail.Api").MessageSelector=t},"1.0.0",{requires:["oop","mail-api-validator","mail-api-base-selector","array-extras"]});
YUI.add("mail-api-display-selector",function(e){"use strict";var t,n=e.mix,r=e.Mail.Api.BaseSelector;t=function(r){function h(e){return e.replace(/\+/g,"-").replace(/\//g,"_")}var i=this,s,o,u,a,f,l,c;r=r||{},a=r.name||"simplebody",s=r.wssid||NeoConfig.wssid,u=r.messageId,o=r.mailboxId||NeoConfig.V3MailboxId,f=r.expandCIDReferences!==!1?!0:!1,c={method:"GetDisplayMessage",params:[{fid:"Inbox",enableRetry:!0,textToHtml:!0,urlDetection:!0,emailDetection:!0,bidiDetection:NeoConfig.bidi,qtAnnotate:{enable:!0},emailComposeUrl:"mailto:%e%",truncateAt:1e5,charsetHint:"",annotateOption:{annotateText:"inline"},message:[{blockImages:"none",restrictCSS:!0,expandCIDReferences:f,enableWarnings:!0,mid:u}]}]},l="/full";if(!u)throw new Error("messageId is required");n(i,{typeName:a,isSimpleBodySecure:function(){return l.indexOf("/secure")>=0},blockImages:function(e){var t=(e||"").toLowerCase();return c.params[0].message[0].blockImages=e,t!=="none"&&(l="/full/secure"),i},expandCIDReferences:function(e){return c.params[0].message[0].expandCIDReferences=e!==!1?!0:!1,i},showFull:function(){return delete c.params[0].truncateAt,i},setFid:function(e){return c.params[0].fid=e,i},setCharsetHint:function(e){return c.params[0].charsetHint=e,i},setFilter:function(t){return t&&(e.mix(c.params[0],t,!0),t.midRequest&&(e.mix(c.params[0].message[0],t.midRequest,!0),c.params[0].midRequest=null)),i},serialize:function(){var e="/ws/v3/mailboxes/@.id=={mailboxId}/messages/@.id=={messageId}/content/simplebody"+l,t={mailboxId:o,messageId:h(u)};return e=e.replace(/\{(.+?)\}/g,function(e,n){return t[n]}),e}}),t.superclass.constructor.call(this,r)},e.extend(t,r),e.namespace("Mail.Api").DisplaySelector=t},"1.0.0",{requires:["oop","mail-api-validator","mail-api-base-selector","array-extras"]});
YUI.add("mail-api-message-updater",function(e){"use strict";var t,n=e.mix,r=e.Mail.Api.Validator,i=e.mail.api.utility,s=e.Mail.Api.MessageSelector,o="messages";t=function(t){function h(t){var n=e.mail.Controller.ImapIn,r=e.mail.ui.FolderUtils;switch(t){case"spam":return n.getFolderByType(r.SpamFolderType,a);case"ham":return n.getFolderByType(r.InboxFolderType,a);case"trash":return n.getFolderByType(r.TrashFolderType,a)}return{id:"invalidFolderId"}}function p(e,t){c.message.flags||(c.message.flags={}),c.message.flags[e]=t}function d(e){var t,n;if(!c.message.decos)c.message.decos=[];else for(t=0;t<c.message.decos.length;t++){n=c.message.decos[t];if(n.id&&n.id===e.id){c.message.decos[t]=e;return}}c.message.decos.push(e)}function v(e){c.message.folder||(c.message.folder={}),c.message.folder.id=e}var u=this,a,f,l=NeoConfig&&NeoConfig.accounts&&NeoConfig.accounts.primaryAccount&&NeoConfig.accounts.primaryAccount[0].id||"",c;t=t||{},f=t.messageSelector,a=t.accountId||l;if(!(f instanceof s))throw new Error("messageSelector must be of type MessageSelector");c={message:{}},n(u,{typeName:o,read:function(){return p("read",!0),u},unread:function(){return p("read",!1),u},star:function(){return p("flagged",!0),u},unstar:function(){return p("flagged",!1),u},move:function(e){return r.isInteger("folderId",e),v(e),u},spam:function(){var e=h("spam");return p("spam",!0),v(e.id),u},trash:function(){var e=h("trash");return v(e.id),u},ham:function(e){var t=h("ham");return p("ham",!0),e?v(e):v(t.id),u},forwarded:function(){return p("forwarded",!0),u},answered:function(){return p("answered",!0),u},notmymail:function(){return p("notmymail",!0),u},phished:function(){return p("phished",!0),u},sendercompromised:function(){return p("sendercompromised",!0),u},isFolderIdUpdating:function(){return c&&c.message&&c.message.folder},updateDecos:function(e){return r.isArray("decos",e),e.forEach(function(e){r.isString("deco",e),d({id:e})}),u},getHash:function(){var e=[];return c.message&&(c.message.flags&&i.eachKeys(c.message.flags,function(t,n){e.push("mark_"+t+"_"+n)}),c.message.folder&&e.push("move_"+c.message.folder.id),c.message.decos&&e.push("updateDecos_"+c.message.decos[0].id)),e.length>0?(e=e.slice(0,3),e.push(i.crc32(JSON.stringify(c))),e.join("-")):""},validateOperation:function(e){if(e==="update"){if(!f._isQueryFulfilled())throw new Error("messageSelector should have fulfilled query for update operation");this.typeName=f.typeName,this.tagSuffix=f.tagSuffix}},serialize:function(e){return u.validateOperation("update"),{url:f.serialize(e)+"&debugAction="+window.encodeURIComponent(this.getHash()),postPayload:c}}}),this.tagSuffix=f.tagSuffix,this.typeName=f.typeName},e.namespace("Mail.Api").MessageUpdater=t},"1.0.0",{requires:["mail-api-message-selector","mail-api-validator","mail-api-utility","mail-controller-imapin","mail-ui-folder-utils"]});
YUI.add("mail-controller-id-tracker",function(e){function u(e,n){var u=this,a={},f=[],l=0;e=e||r,n=n||i;if(r<i)throw new Error("this is designed to have PURGE_SIZE smaller than MAXIDS");return o(u,{_getState:function(){return{idList:a,sources:f,idCount:l}},_purgeIds:function(){var e=0,r=a,i=[];t.eachKeys(r,function(e,t){i.push({key:e,value:t.ts})}),i.sort(function(e,t){return e.value-t.value});for(e=0;e<n;e++)delete r[i[e].key];l=Object.keys(r).length},addSource:function(e){if(f.length>s)return;f.indexOf(e)<0&&f.push(e)},trackID:function(t,n){if(t===undefined||t===null)return;t+="",a[t]||(l+=1),l>e&&u._purgeIds(),a[t]={ts:Date.now(),source:f.indexOf(n)}},getTimeStampOfId:function(e){return a[e]?{ts:a[e].ts,sourceName:f[a[e].source],id:e}:{ts:0,id:e}},getAgeInformationOfOldestId:function(e){var t=0,n=Date.now(),r={age:n,ts:0,id:e&&e[0],sourceName:""},i;return!e||!Array.isArray(e)?r:(e.forEach(function(e){i=u.getTimeStampOfId(e),t<n-i.ts&&(t=n-i.ts,r=i,r.age=Math.round(t/1e3))}),r)}}),this}var t=e.mail.api.utility,n,r=1e4,i=2e3,s=20,o=e.mix;n=new u,e.namespace("mail.controller.v3").idTracker=n,NeoConfig.msgListObj&&Array.isArray(NeoConfig.msgListObj)&&(n.addSource("launch"),NeoConfig.msgListObj.forEach(function(e){n.trackID(e.mid,"launch"),n.trackID(e.cid,"launch")})),e.namespace("Mail.Controller.V3")._IdTracker=u},"1.0.0",{requires:["mail-api-utility"]});
YUI.add("mail-controller-v3-helper",function(e){var t=e.Lang,n=e.mail.ui.FolderUtils,r=e.mail.api.utility,i=e.mail.controller.v3.idTracker,s=e.mail.model.DataStore.Messages,o=e.mail.model.ConvStore.Conversations,u=e.common.Utils.settings,a=e.mail.Controller.ImapIn,f="yoda_cntlr",l={filters:0,blockSenders:0},c;c={folderUtil:n,FLAGS:{replied:"isReplied",flagged:"isFlagged",read:"isRead",draft:"isDraft",forwarded:"isForwarded",ham:"isHam",spam:"isSpam",notmymail:"notmymail"},nextTick:function(e,t){var n=setTimeout(e,1);return{abort:function(){clearTimeout(n),typeof t=="function"&&t()}}},sameTick:function(e){return e(),{abort:function(){}}},pluck:function(n,r){return t.isArray(n)||(n=[n]),e.Array.map(n,function(e){return e[r]||e})},dedupe:function(e,n,r){var i={},s,o;t.isArray(e)||(e=[e]);for(o=e.length-1;o>=0;o--){s=e[o];if(!s||!s[n])continue;i[s[n]]?e.splice(o,1):(r&&r(s),i[s[n]]=!0)}return e},getExponentialDelayedPromise:function(e,t){return new Promise(function(n){e.then(function(e){var r=Math.min(100+Math.pow(2,t),2147483647);setTimeout(function(){n(e)},r)})})},createYodaSyncDebouncer:function(e){var t={},n=function(){var n=Date.now(),r;for(r in t){if(!t.hasOwnProperty(r))continue;n-t[r].time>e&&delete t[r]}};return function(r){var i=Date.now(),s=r.getHash(),o,u,a,f;return n(),f=t[s],f?(f.counter<=50&&f.counter%5===0&&(u=new Error,a={message:"yodadebouncestack",api:r.getTitle(),hash:s,stack:u.stack},c.splunkLog(a,"critical")),f.time=i,f.counter++,c.getExponentialDelayedPromise(f.promise,f.counter).then(function(e){return f.time=Date.now(),e})):(o=r.sync(),t[s]={promise:o,time:i,counter:1},o.then(function(e){return t[s]&&(t[s].time=Date.now()),e}),o)}},getFlagStatusForDS:function(e){var t=c.FLAGS,n={},r;for(r in e)t[r]&&(n[t[r]]=e[r]);return n[t.spam]?n[t.ham]=0:n[t.ham]&&(n[t.spam]=0),n},setFlagInUpdater:function(t){var n=t.setFlags,r=t.updater,i=t.destinationFolderId;return e.Object.each(n,function(e,t){switch(t){case"flagged":e===1?r.star():r.unstar();break;case"read":e===1?r.read():r.unread();break;case"sendercompromised":case"notmymail":case"phished":case"spam":e===1&&r.spam();break;case"ham":e===1&&r.ham(i);break;case"forwarded":e===1&&r.forwarded();break;case"replied":e===1&&r.answered()}}),r},updateUnreadCountForDestOnMove:function(e,t){var n=0,r,i,s;for(r=0;r<t.length;r++)i=t[r],s=i.flags&&i.flags.isRead,n+=s?0:1;e.unread=e.unread+n},getFolderId:function(t){var n=e.mail.model.DataStore.Folders.getByFid(t);return n?n.id:null},setFolderSelection:function(e,t,r){var i=a.getCurrentAccount().id,s=n.getFolderTypeByFid(t),o;switch(s){case n.DraftFolderType:r==="delete"?o=c.getFolderId(n.getDraftFid(i)):r==="flag"&&(e.notFolderType(n.SpamFolderType),e.notFolderType(n.TrashFolderType));break;case n.SentFolderType:r==="move"||r==="delete"?o=c.getFolderId(n.getSentFid(i)):r==="flag"&&(e.notFolderType(n.SpamFolderType),e.notFolderType(n.TrashFolderType));break;case n.SpamFolderType:if(r==="delete"||r==="flag")o=c.getFolderId(n.getSpamFid(i));break;case n.TrashFolderType:if(r==="delete"||r==="flag")o=c.getFolderId(n.getTrashFid(i));break;default:r==="move"||r==="delete"?(e.notFolderType(n.SentFolderType),e.notFolderType(n.DraftFolderType)):r==="flag"&&(e.notFolderType(n.SpamFolderType),e.notFolderType(n.TrashFolderType))}o&&e.folderId(o)},isDestinationForMoveValid:function(t,r){var i=n.getFolderTypeByFid(t),s=r&&n.getFolderTypeByFid(r),o;switch(i){case n.DraftFolderType:s&&(o="move from DRAFT not allowed");break;case n.SentFolderType:s===n.DraftFolderType&&(o="cannot move message to DRAFT");break;default:if(s===n.DraftFolderType||s===n.SentFolderType)o="cannot move message to DRAFT or SENT"}return o?(e.use("common-utils-error",function(){e.common.Utils.error.report(o,1,1,1)}),!1):!0},setSpamHamForMove:function(e,t,r){var i=n.getFolderTypeByFid(t),s=r&&n.getFolderTypeByFid(r),o=c.FLAGS,u={};switch(i){case n.DraftFolderType:break;case n.SpamFolderType:s!==n.SpamFolderType&&s!==n.TrashFolderType&&(e&&e.ham(),u[o.spam]=0,u[o.ham]=1);break;default:s===n.SpamFolderType&&(e&&e.spam(),u[o.spam]=1,u[o.ham]=0)}return u},getFilteredMarkMails:function(e,n){var r=c.FLAGS,i,s,o,u;t.isArray(e)||(e=[e]),i=e.length;for(u=e.length-1;u>=0;u--)if(e[u].flags){if(typeof n.flagged!="undefined"&&e[u].flags[r.flagged]===n.flagged){e.splice(u,1);continue}typeof n.read!="undefined"&&e[u].flags[r.read]===n.read&&e.splice(u,1)}return e.length!==i&&(typeof n.flagged!="undefined"?s=n.flagged?"flag":"unflag":typeof n.read!="undefined"&&(s=n.read?"read":"unread"),o={message:"flagselection",total:i,filtered:i-e.length,op:s},c.splunkLog(o)),e},isYdodActive:function(t){var n="yoda_"+t,r;return NeoGV.isYdod?(e.fire("util:ymstats",{name:"ydodBlock",tags:{api:n,mode:"active"},include:{farm:!0}}),r=e.mail.Errormap.getErrorInfo({code:"999",suppressNotification:!1,suppressStat:!0}),e.mail.Error.showTae(r),!0):!1},preCheckProceed:function(e,t){return!c.isYdodActive(t)},stat:function(t){e.fire("util:ymstats",{name:f+"_"+t})},statTime:function(t,n,r){e.fire("stat:feature_latency",{feature_group:f+"_"+t,message:n,value:r})},splunkLog:function(t,n){n||(n=NeoConfig.isCorpmail?"critical":"info"),e.fire("SplunkLog","debug_v3cntr",t,n)},getIdsfromWriteParams:function(e){return e&&e.messages&&Array.isArray(e.messages)?e.messages.map(function(e){return e.mid}):e&&e.conversations&&Array.isArray(e.conversations)?e.conversations.map(function(e){return e.cid}):[]},_forEachMidCidInLMTResponse:function(e,t){if(!(typeof t=="function"&&e&&e.conversations&&Array.isArray(e.conversations)))return;e.conversations.forEach(function(e){var n=e.conversation,r;if(!n)return;t("cid",n.cid),r=n.messageInfo;if(!r||!Array.isArray(r))return;r.forEach(function(e){t("mid",e.mid)})})},_idTrack:function(e,t){if(!t)return;i.addSource(e);switch(e){case"getConversations":case"getConvList":c._forEachMidCidInLMTResponse(t,function(t,n){i.trackID(n,e)});break;case"getMsgList":if(!t.messageInfo||!Array.isArray(t.messageInfo))return;t.messageInfo.forEach(function(t){i.trackID(t.
mid,e)})}},idTrack:function(e,t){setTimeout(function(){c._idTrack(e,t)},1)},idAge:function(e){return i.getAgeInformationOfOldestId(e)},logIdAge:function(e,t){var n={name:"debug_idage",idAgeInfo:e,code:t};if(NeoConfig.mailEnv==="dev")return console.log("debug_idage====>>>",n);c.splunkLog(n)},logGDMRetrySuccess:function(){c.splunkLog({name:"GDMRetrySuceess"})},getMessageCountBucket:function(e){var t=0;return e<51?t=50:e<101?t=100:e<201?t=200:e<501?t=500:e<1001?t=1e3:e<5001?t=5e3:e<10001?t=1e4:t=10001,t},getBlockedImageSetting:function(t,r){var i=e.common.persist.UserData.get("userUIPref.imageBlocking"),s,o;if(n.isDraftFid(t))return"none";switch(i){case"0":o="none";break;default:o="all"}return strings.str_cfg_tog_old_imageblock?i==="b"&&(o=t==="%40B%40Bulk"?"all":"none"):(n.isSpamFid(t)&&(o="all"),i==="b"&&r&&(s=r.flags)&&s.inAddressBook&&(o="none")),o},midRegex:function(e){return e+="",e=e.substr(e.lastIndexOf("_")+1),e=e.replace(/\//g,"_").replace(/\+/g,"-"),".*"+e+".*"},translateMid:function(e,t){t.forEach(function(t){var n=t.replace(/_/g,"/").replace(/-/g,"+");e.mid.indexOf(n)>=0&&(e.v2mid=e.v2mid?e.v2mid:e.mid,e.mid=t)})},processBody:function(t){return e.mail.Controller.Messages._process(t,{fid:t.sourceFolderInfo.fid,key:t.mid,msg:t}),t},getMsgFid:function(e){return e.fid||e.folderInfo&&e.folderInfo.fid||e.sourceFolderInfo&&e.sourceFolderInfo.fid},getMsgDate:function(e){return e.receivedDate||e.header&&e.header.receivedDate},getMessageToBeExpandedInConv:function(e){var t=e.conv,r=e.sourceFid,i=0,s,o=0,u,a=c.getMsgDate,f=c.getMsgFid,l=function(){},h=Math.floor(Date.now()/1e3),p;return n.isDraftFid(r)||n.isSentFid(r)?(s=i,l=function(t){return f(t)===r&&a(t)>s}):t.totalUnread>0?(s=h,l=function(t){return!t.flags.isRead&&a(t)<s}):(s=i,l=function(t){return a(t)>=s}),t.msgs.forEach(function(e){l(e)&&(p=e,s=a(e)),a(e)>o&&(u=e,o=a(e))}),p||u},checkMailLimit:function(t){function n(e){var n={filters:!1,blockSenders:!1};e&&e.filters&&(l.filters=e.filters.length,e.filters.length>=u.value("maxLimitFilters")&&(n.filters=!0)),e&&e.blockSenders&&(l.blockSenders=e.blockSenders.length,e.blockSenders.length>=u.value("maxLimitBlockedAddresses")&&(n.blockSenders=!0)),t&&t(n)}e.mail.controller.v3.api.getAttributes({filters:!0,blockSenders:!0,success:n})},addAttributeCount:function(t,n){var r={};if(typeof l[t]!==undefined){l[t]=l[t]+n;if(c.isAttributeMaxLimitReached(t)){switch(t){case"filters":r.filters=!0;break;case"blockSenders":r.blockSenders=!0}e.fire("mail:updateMailLimitMarkup",r)}}},getAttributeCount:function(e){return typeof l[e]!==undefined?l[e]:0},isAttributeMaxLimitReached:function(e){var t=!1,n;if(typeof l[e]!==undefined){n=l[e];switch(e){case"filters":t=n>=u.value("maxLimitFilters")?!0:!1;break;case"blockSenders":t=n>=u.value("maxLimitBlockedAddresses")?!0:!1}}return t},iterators:{getConvIdFromMessage:function(){return{typeName:"messages",serialize:function(){return{iterator:"$..messages[0]",select:{conversationId:"$.conversationId"}}}}},getGenericMidsFromConversation:function(){return{typeName:"conversations",serialize:function(){return{iterator:"$..messages[?($['result']['messages'][0]['id']==@.id || !@.flags.read || 'SENT' in @.folder.types)]",select:{mid:"$.id"}}}}},getSpecificMidFromConversation:function(e){return{typeName:"conversations",serialize:function(){return{iterator:"$..messages[?(@.id=~/"+c.midRegex(e)+"/i)]",select:{mid:"$.id"}}}}},getMidFromConversation:function(e){return e?c.iterators.getSpecificMidFromConversation(e):c.iterators.getGenericMidsFromConversation()}},store:{cacheLMT:function(e,t){var n=Date.now();e.forEach(function(e){var r=e.conversation;o.set({conversation:{cid:r.cid,summary:r.summary},folder:t,messageInfo:r.messageInfo,fireEvent:!0},n)})},cacheGDM:function(e,t){var n=e,r;t&&c.translateMid(n,t),n.header&&(n.messageIdRfc822=n.header.messageId,n.inReplyToRfc822=n.header.inReplyTo,r=c.getMsgDate(c.store.getMessage(c.getMsgFid(n),n)),n.GDMDate=n.header.receivedDate,r&&(n.header.receivedDate=n.receivedDate=r*1)),n.cid=o.getPermCidPart(n.cid),n.fid=n.sourceFolderInfo.fid,s.set(n.sourceFolderInfo.fid,n,"get",!0,c.processBody)},filterUnreadMessages:function(e){var t={},n=[];return Array.isArray(e)?(e.forEach(function(e){var n=c.store.getMessage(c.getMsgFid(e),e);n&&n.mid&&(t[n.mid]=n)}),r.eachKeys(t,function(e,t){t.flags.isRead||n.push(t)}),n):[]},getMessage:function(e,t){var n=s.get(e,t.mid);return n?n:(t.fid&&(n=s.get(t.fid,t.mid)),n?n:!1)}}},e.namespace("mail.controller.v3").helper=c},"1.0.0",{requires:["mail-model-datastore","mail-model-convstore","mail-controller-imapin","mail-ui-folder-utils","common-persist-user-data","array-extras","mail-api-utility","mail-errormap","mail-error","mail-controller-id-tracker","mail-common-utils-settings"]});
YUI.add("mail-api-decos-selector",function(e){"use strict";var t,n=e.Mail.Api.BaseSelector,r=e.mix;t=function(e){var n=this,i;i=e&&e.mailboxId||NeoConfig.V3MailboxId,r(n,{typeName:"decos",selectInbox:function(){return n.keyName="FTI",n},serialize:function(){var e="";return n.keyName&&(e="/@.id=="+n.keyName),"/ws/v3/mailboxes/@.id=="+n._urlEscape(i)+"/decos"+e}}),t.superclass.constructor.call(this,e)},e.extend(t,n),e.namespace("Mail.Api").DecosSelector=t},"1.0.0",{requires:["oop","mail-api-base-selector"]});
YUI.add("mail-api-decos-updater",function(e){"use strict";var t,n=e.mix,r=e.Mail.Api.DecosSelector,i="decos";t=function(e){var t=this,s=[],o;o=e&&e.decosSelector||{};if(!(o instanceof r))throw new Error("decosSelector must be of type DecosSelector");n(t,{typeName:i,resetUnseen:function(e){var t;if(!e)throw new Error("resetUnseen must get accountId");for(t=0;t<s.length;t++)if(s[t].accountId===e&&s[t].unseen===0)return;s.push({accountId:e,unseen:0})},serialize:function(){return{url:o.serialize(),postPayload:{id:o.keyName,counts:s}}}})},e.namespace("Mail.Api").DecosUpdater=t},"1.0.0",{requires:["mail-api-decos-selector","array-extras"]});
YUI.add("mail-controller-v3-converter",function(e){function l(e){return e.type==="image"}function c(e){return e=e||{},{email:e.email||"",name:e.name||e.email||""}}function h(e){var t=[],n,r;for(n=0;n<e.msgs.length;n++)r=e.msgs[n],t.push({mid:r.mid,fid:r.fid});return t}function p(e){var t=[],n,r,i,o={},u=[],a=[],f=[];return Array.isArray(e)?(e.forEach(function(e){s.isDraftFid(e.sourceFolderInfo.fid)?(t.push(e),typeof e.inReplyToRfc822=="string"&&(n=e.inReplyToRfc822.match(/(<.+?>)/),n&&(e.inReplyToRfc822=n[1])),f.push(e.inReplyToRfc822||"")):(e.messageIdRfc822&&(o[e.messageIdRfc822]||(o[e.messageIdRfc822]=[]),o[e.messageIdRfc822].push(e.mid)),u.push(e))}),u.forEach(function(e){var n;a.push(e);if(e.messageIdRfc822&&(n=o[e.messageIdRfc822]))if(n.length===1)while((r=f.indexOf(e.messageIdRfc822))>=0)i=t.splice(r,1)[0],f.splice(r,1),i.oMsgMid=e.mid,a.push(i);else r=n.indexOf(e.mid),n.splice(r,1)}),a.concat(t)):e}function d(e){var t={},n=[];return Array.isArray(e)?(e.forEach(function(e,n){var r=e.sourceFolderInfo.fid,i=e.receivedDate,o=s.isSentFid(r),u=s.isDraftFid(r),a=o||u?e.csid||"csid-"+n:"csid-"+n,f={msg:e,receivedDate:i,isSent:o,isDraft:u};if(!t[a]){t[a]=f;return}if(o){t[a]=f;return}t[a].receivedDate<i&&!t[a].isSent&&(t[a]=f)}),r.eachKeys(t,function(e,t){n.push(t.msg)}),n):e}function v(e){return e.headers.inReplyTo?e.headers.inReplyTo:e.headers.references||""}function m(e){return e&&e.name||e&&e.from}function g(e){return e&&e.headers&&e.headers.from&&Array.isArray(e.headers.from)&&e.headers.from[0]?!0:!1}function y(e){var t={name:"",email:""},n=g(e)&&e.headers.from.map(c)[0]||t;return n}function b(e,t){var n=[],i=y(e),s=y(t),o=0,u=function(e){return function(n){return!n||!g(e)?!1:e.headers.from[0].name?n.name===e.headers.from[0].name:e.headers.from[0].email?n.email===e.headers.from[0].email:!1}};return{nextMsg:function(e){var t=u(e);o+=1;if(!g(e))return;!t(i)&&!t(s)&&e.headers.from.map(c)[0]&&r.findPush(n,e.headers.from.map(c)[0],t)},getParticipants:function(){return m(i)&&n.unshift(i),o>1&&m(s)&&n.push(s),n.reverse(),n.length===2&&i.name===s.name&&n.pop(),n}}}function w(e){return e&&e.id&&e.id==="CPN"}function E(e,t){var n=e.messages[e.messageIds[e.messageIds.length-1]],s=e.messages[e.messageIds[0]],o=b(s,n),u,a,h=0,p=!1,d=!1,m=!1,g=!1,y=[],E={},S,x=0,T={folderInfo:{fid:t,name:""},isSystem:!1},N=[],C=0,k,L,A;for(k in e.messages)L=e.messages[k],S=L.folder.oldV2Fid,a={},u=[],E[S]||(E[S]={total:0,unread:0}),S===t&&(T.folderInfo.name=L.folder.name,T.isSystem=L.folder.types.indexOf("USER")<0,h=Math.max(h,L.headers.internalDate*1||0)),x+=L.size,E[S].total=E[S].total+1,E[S].unread=E[S].unread+(L.flags.read?0:1),o.nextMsg(L),p=p||L.attachments&&Array.isArray(L.attachments)&&L.attachments.length>0||L.attachmentCount>0,p&&(g=g||f(L.attachments,l)),d=i.enabled("expiringCouponsPreviewIcon")?L.cardConversationId&&L.decos&&Array.isArray(L.decos)&&L.decos.some(w):!1,m=m||L.folder.types.indexOf("DRAFT")>=0,C+=L.flags.flagged?1:0,A=L.headers.internalDate&&L.headers.internalDate*1||L.headers.date*1||0,L.verifiedDomains&&Array.isArray(L.verifiedDomains)&&(a.verifieddomain=L.verifiedDomains[0].domain,u.push({name:"verifieddomain",value:L.verifiedDomains[0].domain})),N.push({mid:L.id,cid:L.conversationId,csid:L.csid,fid:L.folder.oldV2Fid,flags:{isReplied:L.flags.answered?1:0,isFlagged:L.flags.flagged?1:0,isRead:L.flags.read?1:0,isDraft:m,isForwarded:L.flags.forwarded?1:0,isHam:L.flags.ham?1:0,isSpam:L.flags.spam?1:0,inAddressBook:L.flags.addressBook?1:0,hasAttachment:p?1:0,hasCoupon:d?1:0,hasImage:g,isRecent:L.flags.recent?1:0},header:{from:c(L.headers.from&&L.headers.from[0]),to:L.headers.to,cc:L.headers.cc||[],bcc:L.headers.bcc||[],replyto:L.headers.replyto||[],subject:L.headers.subject||"",snippet:L.snippet||"",externalPopServer:null,receivedDate:A,inReplyTo:L.headers.inReplyTo,inReplyToRfc822:v(L),messageIdRfc822:L.headers.messageIdRfc822,size:L.size},from:c(L.headers.from&&L.headers.from[0]),toEmail:L.headers.to&&L.headers.to[0]&&(L.headers.to[0].name||L.headers.to[0].email),to:L.headers.to,inReplyTo:L.headers.inReplyTo,inReplyToRfc822:v(L),messageIdRfc822:L.headers.messageIdRfc822,subject:L.headers.subject||"",snippet:L.snippet||"",mimeMsgId:L.id,receivedDate:A,size:L.size,sourceFolderInfo:{fid:L.folder.oldV2Fid,name:L.folder.name},srvmap:a,inboxservices:u,classification:L.classification,decos:L.decos||[],cardConversationId:L.cardConversationId||""});for(S in E)y.push({fid:S,total:E.total,unread:E.unread});return{summary:{subject:n&&n.headers.subject,totalMsgs:e.total,unreadMsgs:e.unread,totalSize:x,checksum:r.crc32(e.messageIds.join("")),iDate:h,hasAttachment:p,hasCoupon:d,hasDraft:m,flaggedMsgs:C,participantList:o.getParticipants(),msgCountsByFolder:y},messageInfo:N,folderSummary:T}}function S(e,t){var n=E(e,t);return{conversation:{cid:e.id,summary:n.summary,messageInfo:n.messageInfo},folderSummary:n.folderSummary}}function x(e){var t=e.attachments&&Array.isArray(e.attachments)&&e.attachments.length>0||e.attachmentCount>0,n=i.enabled("expiringCouponsPreviewIcon")?e.cardConversationId&&e.decos&&Array.isArray(e.decos)&&e.decos.some(w):!1,r=!1,s=!1,o=!1,u={},a=[],h;return t&&(o=!!f(e.attachments,l)),r=e.folder.types.indexOf("DRAFT")>=0,s=e.folder.types.indexOf("USER")<0,h=e.headers.internalDate&&e.headers.internalDate*1||e.headers.date*1||0,e.verifiedDomains&&Array.isArray(e.verifiedDomains)&&(u.verifieddomain=e.verifiedDomains[0].domain,a.push({name:"verifieddomain",value:e.verifiedDomains[0].domain})),{mid:e.id,cid:e.conversationId,csid:e.csid,flags:{isReplied:e.flags.answered?1:0,isFlagged:e.flags.flagged?1:0,isRead:e.flags.read?1:0,isDraft:r,isForwarded:e.flags.forwarded?1:0,isHam:e.flags.ham?1:0,isSpam:e.flags.spam?1:0,inAddressBook:e.flags.addressBook?1:0,hasAttachment:t?1:0,hasCoupon:n?1:0,hasImage:o,isRecent:e.flags.recent?1:0},from:c(e.headers.from&&e.headers.from[0]),fromFBUser:null,searchinfo:null,srvmap:u,inboxservices:a,header:{from:c(e.headers.from&&e.headers.from[0]),to:e.headers.to,cc:e.headers
.cc||[],bcc:e.headers.bcc||[],replyto:e.headers.replyTo||[],xapparentlyto:[],subject:e.headers.subject||"",snippet:e.snippet||"",externalPopServer:null,receivedDate:h,size:e.size,inReplyTo:e.headers.inReplyTo,messageIdRfc822:e.headers.messageIdRfc822,inReplyToRfc822:v(e)},folderInfo:{fid:e.folder.oldV2Fid,name:e.folder.name,isSystem:s,index:e.folder.id},sourceFolderInfo:{fid:e.folder.oldV2Fid,name:e.folder.name,index:e.folder.id},uid:e.id,uidl:e.id,errorflag:null,retriable:null,toEmail:e.headers.to&&e.headers.to[0]&&(e.headers.to[0].name||e.headers.to[0].email),to:e.headers.to,toEmailDir:"auto",subject:e.headers.subject||"",snippet:e.snippet||"",snippetDir:"auto",subjectDir:"auto",mimeType:"multipart/mixed",xapparentlyto:null,mimeMsgId:null,inReplyTo:e.headers.inReplyTo,messageIdRfc822:e.headers.messageIdRfc822,inReplyToRfc822:v(e),externalPopServer:null,receivedDate:h,size:e.size,classification:e.classification,FilterResultBean:e.filterResult,msgSnippet:e.snippet,decos:e.decos||[],cardConversationId:e.cardConversationId||""}}function T(e){var t=e.conversations.length,n=[],r,i,s=0,o,u,f,l=e.folder;e.convInfo=[];if(l.total&&!t&&l.folderInfo.fid!=="%40B%40Bulk"){e.code="ResponseCountMismatch";return}for(i=0;i<t;i++)u=e.conversations[i].conversation.messageInfo,o=u&&u[0]&&u[0].receivedDate,o>s&&(s=o);f=Date.now();for(i=0;i<t;i++)r=a.toConvInfo(e.folder.folderInfo.fid,e.conversations[i]),r.snapshotTime=s,r.reqTime=f,n.push(r);e.convInfo=n}function N(e,t,n){var r=0,i=e.length,s,u=[],a=o.get(t),f={folderInfo:a.folderInfo,unread:a.unread,total:a.total,size:0,isSystem:!1,totalConversations:i};n=n||{count:1,start:-1},n.start>=0&&i<n.count?f.totalConversations=n.start+i:n.start>=0&&(f.totalConversations=n.start+i+1);for(r=0;r<i;r++)s=S(e[r],t),f.size=f.size+s.conversation.summary.totalSize,f.isSystem=s.folderSummary.isSystem,u.push({conversation:s.conversation});return{conversations:u,folder:f}}function C(e,t,n){var r=e.length,i=o.get(t),s,u,a=[],f={folderInfo:i.folderInfo,unread:i.unread,total:i.total,size:0,isSystem:!1,softDeleted:0,unreadSoftDeleted:0};for(s=0;s<r;s++)u=x(e[s]),f.size=f.size+u.size,f.isSystem=u.folderInfo.isSystem,a.push(u);return{messageInfo:a,folder:f,startMid:0,numMid:0,startInfo:n,numInfo:e.length}}function k(e,t){var n,r={totalFlagged:0,totalHasAttach:0,totalHasCoupon:0,totalMsgs:0,totalUnread:0,totalDraft:0};for(n=0;n<e.msgs.length;n++)e.msgs[n].originalOrder===undefined&&(e.msgs[n].originalOrder=n),e.msgs[n].header||(e.msgs[n]=u.toMessage(t.sourceFid,e.msgs[n]));return e.midMap||(e.midMap=h(e)),e=a.calcConvSummary(e),e.msgs=d(e.msgs),e.msgs=e.msgs.reverse(),e.msgs.sort(function(e,t){var n=e.receivedDate||e.header&&e.header.receivedDate,r=t.receivedDate||t.header&&t.header.receivedDate;return n-r}),e.msgs=p(e.msgs),e.midMap=h(e),e.msgs.forEach(function(e){r.totalFlagged=r.totalFlagged+(e.flags.isFlagged?1:0),r.totalHasAttach=r.totalHasAttach+(e.flags.hasAttachment?1:0),r.totalHasCoupon=r.totalHasCoupon+(e.flags.hasCoupon?1:0),r.totalMsgs=r.totalMsgs+1,r.totalUnread=r.totalUnread+(e.flags.isRead?0:1),r.totalDraft=r.totalDraft+(e.flags.isDraft?1:0)}),e.totalFlagged=r.totalFlagged,e.totalHasAttach=r.totalHasAttach,e.totalHasCoupon=r.totalHasCoupon,e.totalMsgs=r.totalMsgs,e.totalUnread=r.totalUnread,e.totalDraft=r.totalDraft,e}function L(e){var t=e.simpleBody.html||e.simpleBody.text||"",n=t.substr(0,50).match(/id=\"(yiv[0-9]+?)\"/);return{text:e.simpleBody.html||e.simpleBody.text,bidi:e.simpleBody.bidi,contentId:"",disposition:"",dispParams:"",filename:"",partId:"TEXT",referencedInline:!1,size:e.simpleBody.html.length*2,subtype:"html",type:"text",typeParams:"charset=utf-8",yivPrefixNumber:n&&n[1]||"",isTruncated:!1}}function A(e){var t;return e.message.attachments&&Array.isArray(e.message.attachments)&&e.message.attachments[0]?(t=e.message.downloadAllUrl,e.message.attachments.map(function(e){return e.referencedInline=e.disposition==="inline",e.typeParams="charset=utf-8",e.yivPrefixNumber="",e.isTruncated=!1,e.thumbnailurl=e.thumbnailUrl,e.downloadUrlV3=e.downloadUrl,e.downloadAllUrl=t||e.downloadUrl,e})):[]}function O(e,t){var n,r,i;return e==="display"?t.message[0]:(n=t.message,i=x(n),i.yqtClassId="",i.hasBlockedImages=!1,t.simpleBody&&t.simpleBody.htmlAnnotations&&Array.isArray(t.simpleBody.htmlAnnotations)&&t.simpleBody.htmlAnnotations.forEach(function(e){e.type==="quoted"&&(i.yqtClassId=e.classId,i.otherDivIds=e.divids),e.type==="blocked"&&t.isSimpleBodySecure&&(i.hasBlockedImages=!0)}),i.part=[L(t)],r=A(t),i.hasBlockedImages&&(r=r.filter(function(e){return e.type!=="image"})),i.part=i.part.concat(r),i)}var t,n=e.mail,r=e.mail.api.utility,i=e.common.Utils.features,s=e.mail.ui.FolderUtils,o=n.model.DataStore.Folders,u=n.model.DataStore.Messages,a=n.model.ConvStore.Conversations,f=r.arrayFind;t={listMessages:C,getDisplayMessage:O,listMessageThreads:N,generateConvInfo:T,getConvPaneContent:k,getParticipantListBuilder:b},e.namespace("mail.controller.v3").converter=t},"1.0.0",{requires:["mail-model-datastore","mail-model-convstore","mail-api-utility"]});
YUI.add("mail-api-folder-selector",function(e){"use strict";var t,n=e.mix,r=e.Mail.Api.BaseSelector;t=function(e){function o(e,t){s[e]=t}var r=this,i,s;e=e||{},i=e.mailboxId||NeoConfig.V3MailboxId,s={},n(r,{typeName:"folders",id:function(e){return o("id",e),r},serialize:function(){var e="/ws/v3/mailboxes/@.id=="+r._urlEscape(i)+"/folders";return s.id&&(e=e+"/@.id=="+r._urlEscape(s.id)),e}}),t.superclass.constructor.call(this,e)},e.extend(t,r),e.namespace("Mail.Api").FolderSelector=t},"1.0.0",{requires:["oop","mail-api-validator","mail-api-base-selector","array-extras"]});
YUI.add("mail-controller-v3",function(e){function z(){e.on("mail:navigateIn",function(){pt()}),e.on("mail:fetchFiltersBlockSenders",function(e){var t=e&&e.callback;S.checkMailLimit(t)}),e.on("list:sortChange",function(e){F.groupBy=e.groupBy,F.sortKey=e.sortKey,F.sortOrder=e.sortOrder}),e.on("ds:account:remove",function(){I.length=0,W()})}function W(){return new Promise(function(e){var t=new r,n;if(I.length>0){e(I);return}t.decos.get(new c).sync().then(function(t){var r=t.decos.get[0];if(!r.success){e([w.getPrimaryAccount().id]);return}n=r.result.filter(function(e){return e.id==="FTI"}),n[0]&&n[0].counts&&(I=n[0].counts.map(function(e){return e.accountId})),I.length||(I=[w.getPrimaryAccount().id]),e(I)})})}function X(e,t,n){var r=n==="messages"?t.messages:t.conversations,i=n==="messages"?m:g,s=n==="messages"?"flag":"conv_flag",u=t.flags,a={},f;for(f in u)f==="read"&&(a[S.FLAGS[f]]=u[f]?0:1);typeof u.read!="undefined"&&(i.update(t.sourceFid,r,{flags:a},s),o.triggerCheckMail(0))}function V(){var e=o.yTimerObj;e&&e.cancel&&e.cancel()}function $(e,t){var n=[],r,i;if(e.length>_){for(r=0,i=e.length;r<i;r+=_)n.push(e.slice(r,r+_));n.forEach(function(e){t(e)})}else t(e)}function J(e,t){var n=t.method,r=e.messages,i=S.pluck(r,"mid"),s=e.sourceFid,o=e.destinationFid,u,a;switch(n){case"update":t.optimisticRemove||m.remove(s,r,!o,o,{}),m.move(s,o,i,i,"move",{});break;case"remove":m.remove(s,r,!o,o,{})}u=S.folderUtil.getFolderByName(s,e.mailAcctId),u&&b.set(u,"ds:msg:",1),a=o&&S.folderUtil.getFolderByName(o,e.mailAcctId),a&&(S.updateUnreadCountForDestOnMove(a,r),b.set(a,"ds:msg:",1))}function K(e,t){var n=t.method,r=e.conversations,i=S.pluck(r,"cid"),s=e.sourceFid,o=e.destinationFid,u,a;switch(n){case"update":t.optimisticRemove||g.remove(s,r,o),g.move(s,o,i,null,"move");break;case"remove":g.remove(s,r,o)}u=S.folderUtil.getFolderByName(s,e.mailAcctId),u&&b.set(u,"ds:conv:",1),a=o&&S.folderUtil.getFolderByName(o,e.mailAcctId),a&&b.set(a,"ds:conv:",1)}function Q(e,t,n){var r=t.entity,i=t.method,s=0,u="update_"+t.actionTitle+"_"+(n.isBulkOperation?"async":"sync"),a=Date.now(),f=S.idAge(S.getIdsfromWriteParams(n)),l=n.isBulkOperation||e.detector.hasMessageChangedFolder();return l&&V(),n.isBulkOperation&&n.progress&&e.onChange(function(e){var t=e[r][i],o=t.length,u=0;t.forEach(function(e){u+=e.progress}),u/=o,u>s?s=u:u=s,n.progress({processed:u,total:100})}),x(e).then(function(s){var c=s[r][i][0]||{},h=Date.now()-a;c.success?(l&&o.triggerCheckMail(),t.updateStore&&(r==="conversations"?K(n,t):J(n,t)),S.statTime(u,"success",h),n.success&&n.success(c.progress)):(l&&o.triggerCheckMail(0),t.actionTitle==="flag"&&X(s,n,r),S.logIdAge(f,c.yodaErrorCode),n.failure&&n.failure()),e=null}),{abort:function(){if(e)return e.cancelSync()}}}function G(e){var t="updateDecos",n=new r({actionTitle:t}),i=u.getCurrentAccount().id,s={entity:"messages",method:"update",actionTitle:t,updateStore:!1};if(e.messages&&e.messages.length<=0)return;return $(e.messages,function(t){var r=new a({isBulkOperation:e.isBulkOperation||!1}),s=new d({messageSelector:r,accountId:i});r.id(t),s.updateDecos(e.decos),n.messages.update(s)}),Q(n,s,e)}function Y(t){var n="flag",i=new r({showTAE:t.showTAE,statTAE:t.statTAE,actionTitle:n}),s=u.getCurrentAccount().id,o=e.mail.ui.FolderUtils,f=t.flags,l=S.getFlagStatusForDS(f),c=f.notmymail||f.phished||f.sendercompromised,h=f.ham||f.spam,p=t.destinationFid&&o.getFolderByName(t.destinationFid),v=p&&p.id,g={entity:"messages",method:"update",actionTitle:n,updateStore:h||c,optimisticRemove:!1},y;t.notifyStoreMsgByMsg?t.messages=S.dedupe(t.messages,"mid",function(e){m.update(S.getMsgFid(e),[e]||[],{flags:l},"flag")}):m.update(t.sourceFid,t.messages||[],{flags:l},"flag"),y=S.pluck(t.messages,"mid");if(y.length<=0)return;return $(y,function(e){var n=new a({isBulkOperation:t.isBulkOperation||!1}),r=new d({messageSelector:n,accountId:s});n.id(e),r=S.setFlagInUpdater({setFlags:f,updater:r,destinationFolderId:v}),i.messages.update(r)}),c&&(t.destinationFid=o.getSpamFid(s)),Q(i,g,t)}function Z(e){var t="move",n=new r({actionTitle:t}),s=u.getCurrentAccount().id,o=S.pluck(e.messages,"mid"),f=e.destinationFid,l=f&&S.folderUtil.getFolderByName(f,e.mailAcctId),c={entity:"messages",method:"update",actionTitle:t,updateStore:!0,optimisticRemove:!1},h;if(o.length<=0)return;return h=S.setSpamHamForMove(null,e.sourceFid,e.destinationFid),i.isEmpty(h)||m.update(e.sourceFid,e.messages||[],{flags:h},"flag"),e.messages.length<=D&&(c.optimisticRemove=!0,m.remove(e.sourceFid,e.messages,!f,f,{})),$(o,function(t){var r=new a({isBulkOperation:e.isBulkOperation||!1}),i=new d({messageSelector:r,accountId:s});r.id(t),i.move(l.id),S.setSpamHamForMove(i,e.sourceFid,e.destinationFid),n.messages.update(i)}),Q(n,c,e)}function et(e){var t="remove",n=new r({showTAE:e.showTAE,statTAE:e.statTAE,actionTitle:t}),i=u.getCurrentAccount().id,s=e.sourceFid,o=u.getMsgPermDeleteFolders(i).indexOf(s)>-1?!0:!1,f=S.pluck(e.messages,"mid"),l={entity:"messages",method:"remove",actionTitle:t,updateStore:!0,optimisticRemove:!1};if(f.length<=0)return;return!o&&e.destinationFid?Z(e):($(f,function(t){var r=new a({isBulkOperation:e.isBulkOperation||!1});r.id(t),n.messages.remove(r)}),Q(n,l,e))}function tt(t){var n="flag",i=new r({showTAE:t.showTAE,statTAE:t.statTAE,actionTitle:n}),s=u.getCurrentAccount().id,o=S.pluck(t.conversations,"cid"),f=e.mail.ui.FolderUtils,l=t.flags,c=l.notmymail||l.phished||l.sendercompromised,h=l.ham||l.spam,p=t.destinationFid&&f.getFolderByName(t.destinationFid),v=p&&p.id,m={entity:"conversations",method:"update",actionTitle:n,updateStore:h||c,optimisticRemove:!1};if(o.length<=0)return;return g.update(t.sourceFid,t.conversations||[],{flags:S.getFlagStatusForDS(l)},"conv_flag"),c&&(t.destinationFid=f.getSpamFid(s)),$(o,function(e){var n=new a({isBulkOperation:t.isBulkOperation||!1}),r=new d({messageSelector:n,accountId:s});n.conversationId(e),n.acctId(s),S.setFolderSelection(n,t.sourceFid,"flag"),S.setFlagInUpdater({setFlags:l,updater:r,destinationFolderId
:v}),i.conversations.update(r)}),Q(i,m,t)}function nt(t){var n="move",s=new r({actionTitle:n}),o=e.mail.ui.FolderUtils,f=u.getCurrentAccount().id,l=S.pluck(t.conversations,"cid"),c=t.destinationFid&&o.getFolderByName(t.destinationFid,t.mailAcctId),h={entity:"conversations",method:"update",actionTitle:n,updateStore:!0,optimisticRemove:!1},p;if(l.length<=0)return;if(!S.isDestinationForMoveValid(t.sourceFid,t.destinationFid))return;return p=S.setSpamHamForMove(null,t.sourceFid,t.destinationFid),i.isEmpty(p)||g.update(t.sourceFid,t.conversations||[],{flags:p},"conv_flag"),t.conversations.length<=D&&(h.optimisticRemove=!0,g.remove(t.sourceFid,t.conversations,t.destinationFid)),$(l,function(e){var n=new a({isBulkOperation:t.isBulkOperation||!1}),r=new d({messageSelector:n,accountId:f});n.conversationId(e),n.acctId(f),S.setFolderSelection(n,t.sourceFid,"move"),r.move(c.id),S.setSpamHamForMove(r,t.sourceFid,t.destinationFid),s.conversations.update(r)}),Q(s,h,t)}function rt(e){var t="remove",n=new r({actionTitle:t}),i=u.getCurrentAccount().id,s=e.sourceFid,o=u.getMsgPermDeleteFolders(i).indexOf(s)>-1?!0:!1,f=S.pluck(e.conversations,"cid"),l={entity:"conversations",method:"remove",actionTitle:t,updateStore:!0,optimisticRemove:!1};if(f.length<=0)return;return!o&&e.destinationFid?nt(e):($(f,function(t){var r=new a({isBulkOperation:e.isBulkOperation||!1});r.conversationId(t),r.acctId(i),S.setFolderSelection(r,e.sourceFid,"delete"),n.conversations.remove(r)}),Q(n,l,e))}function it(t){var n=t.action+"_folder",s=new r({actionTitle:n}),f=new a({isBulkOperation:t.isBulkOperation}),l=u.getCurrentAccount().id,c=t.sourceFid,h=e.mail.ui.FolderUtils,p=u.getMsgPermDeleteFolders(l).indexOf(c)>-1?!0:!1,v=new d({messageSelector:f,accountId:l}),m=i.settings.value("folderAPIV3LimitCount"),g=h.getFolderByName(t.sourceFid).id,y,b,w;f.folderId(g),f.page.count(m);switch(t.action){case"emptyFolder":b=u.getFolderByType("TRASH",l)||"",p?(v=f,w="remove"):(v.move(b.id),w="update");break;case"markReadFolder":f.isUnread(),v.read(),w="update";break;case"archiveFolder":b=u.getFolderByType("ARCHIVE",l)||"",v.move(b.id),w="update"}return S.stat(n+"_invoked"),V(),t.isBulkOperation&&t.progress&&s.onChange(function(e){t.progress(e.messages[w][0].progress)}),s.messages[w](v),y=Date.now(),s.sync().then(function(r){var u=r.messages[w]&&r.messages[w][0]||{},a=Date.now()-y,f,l;o.triggerCheckMail(0),t.success(u.progress),t.action==="markReadFolder"&&i.features.enabled("LFTCache")&&e.use("mail-model-liststore",function(e){e.mail.model.ListStore.ListCache.invalidate(c)}),u.success||u.abort?l="success":l="failed",S.stat(n+"_"+l),S.statTime(n,l,a),f={name:"folderOperation",type:t.action,messageBucket:S.getMessageCountBucket(t.totalMsgs),status:l,latency:a},S.splunkLog(f),s=null}),{abort:function(){S.stat(n+"_abort");if(s)return s.cancelSync()}}}function st(e){var t=new a,n=[],i={hasAttachment:"attachment",unRead:"unread",flagged:"flagged"},s=e.entity,o=new r({actionTitle:"get-"+s+"-list"});return t.folderId(S.getFolderId(e.fid)),s==="conversations"&&t.groupByConversation(),L&&t.messageType(S.folderUtil.getFolderTypeByFid(e.fid)),e.start&&t.page.offset(e.start),e.count&&t.page.count(e.count),e.sortKey&&e.sortOrder&&(e.groupBy?i[e.groupBy]&&n.push(i[e.groupBy]):(e.sortOrder==="down"&&e.sortKey==="date"&&n.push("-"),n.push(e.sortKey)),t.page.sortBy(n.join(""))),o[s].get(t),o}function ot(e){var t;return e.entity="conversations",t=st(e),x(t).then(function(n){var r=n.conversations.get[0],s;if(r.abort)return;if(!r.success)return e.failure();s=p.listMessageThreads(r.result,e.fid,{count:e.count,start:e.start}),p.generateConvInfo(s),S.idTrack("getConvList",s),e.success(s),i.rAF(function(){S.store.cacheLMT(s.conversations,s.folder)}),t=null}),{abort:function(){t&&t.cancelSync()}}}function ut(e){var t;return e.entity="messages",t=st(e),x(t).then(function(n){var r=n.messages.get[0],i;if(r.abort)return;if(!r.success)return e.failure();i=p.listMessages(r.result,e.fid,e.start),S.idTrack("getMsgList",i),e.success(i),t=null}),{abort:function(){t&&t.cancelSync()}}}function at(e){var t=e.yoda,n=!!e.conversationId,r=!n&&e.messageId,i=n?e.conversationId:"$(conversationId)",s=new a,o=new a;o.conversationId([i]),o.tag(e.tag),e.cfid&&o.messageType(S.folderUtil.getFolderTypeByFid(e.cfid)),r?s.id([e.messageId]):e.cfid&&o.acctId(S.folderUtil.getAcctIdByFid(e.cfid));if(!n&&!e.messageId)throw new Error("Either conversationId or messageId is required for getConversation call");return n||t.messages.pipe(s,C.getConvIdFromMessage()),e.getDisplay?(t.conversations.pipe(o.tag(e.tag),C.getMidFromConversation(r)),t[O].get((new v({name:O,messageId:"$(mid)",expandCIDReferences:A})).tag(e.tag+"-optional-$(mid)").blockImages(S.getBlockedImageSetting(e.cfid))),t.closePipe()):t.conversations.get(o),n||t.closePipe(),t}function ft(t){var n=new r({actionTitle:"getConversation",showTAE:t.showTAE,statTAE:t.statTAE}),i=[],s=[],o=[],u=t.pane===!1?!1:!0,a=0,f=!1,l=S.idAge(t.items.map(function(e){return e.messageId||e.conversationId})),c=function(e,t){e==="success"?i.push(t):e==="failure"&&s.push(t||{})},h=function(){n=null,t.success&&t.success(i,s),f&&q()};return t.items.forEach(function(r){var i=!!r.conversationId,s=!i&&r.messageId,f=!i&&s&&g.midToConv(r.cfid,s),l={sourceFid:r.cfid,newMsg:r.newMsg,oldMsgCnt:r.oldMsgCnt||0},h,d,v,m,y,b,w;m="_"+a+"_",v={tag:m,messageId:r.messageId,conversationId:r.conversationId,hasConvId:i,cfid:r.cfid,mfid:r.mfid,useMessageId:s,convPaneContent:null,paneContentOption:l},i?h=r.conversationId:f?(h=f.cid,i=!0):h="$(conversationId)",i&&g.isCached(r.cfid,h)?(d=g.get(r.cfid,h,!0),u?(l.originalLen=d.msgs.length,w=p.getConvPaneContent(d,l)):w=d,y=s?{mid:s}:S.getMessageToBeExpandedInConv({conv:w,sourceFid:r.cfid||r.mfid}),t.getDisplay?b=e.mail.controller.v3.api.getSimpleBodyofMessages({messageList:[y],sourceFid:S.getMsgFid(y)||r.cfid,yoda:n,tag:v.tag,isPrefetchCall:t.isPrefetchCall}):b=[],b.length>=1?(w.fullmsg=b[0],c("success",w)):t.getDisplay?(v.convPaneContent=w,v.isConvPaneContent=!0
,o.push(v)):c("success",w)):(at({conversationId:r.conversationId,cfid:r.cfid,messageId:r.messageId,getDisplay:t.getDisplay,tag:m,yoda:n}),o.push(v)),a+=1}),n.hasItemToSync()?(T(n).then(function(){var e=null,r=0;e=R&&n.getResponseByEntity(M,"get"),e&&e.length>0&&e.forEach(function(e){E.setCardConversation(e.result,"Coupon",!0)}),o.forEach(function(e){var i=e.tag,s,o=n.getResponseByTag("conversations",i),a,d,v,m,y=Date.now(),b;if(!e.convPaneContent){if(o.abort){c();return}o.success&&o.result.length>=1||c("failure",{reason:o.taeMapCode}),b=p.listMessageThreads(o.result,e.cfid,{start:-1,countQueried:1}),p.generateConvInfo(b),S.idTrack("getConversations",b),b.conversations.forEach(function(t){var n=t.conversation;e.hasConvId||(e.conversationId=n.cid),g.set({conversation:{cid:n.cid,summary:n.summary},folder:b.folder,messageInfo:n.messageInfo},y)}),s=g.get(e.cfid,e.conversationId,!0)}else s=e.convPaneContent;if(!s){c("failure",d);return}m=(s.msgs||[]).map(function(e){return e.mid}),u&&!e.convPaneContent?(e.paneContentOption.originalLen=s.msgs.length,d=p.getConvPaneContent(s,e.paneContentOption)):d=s,v=S.getMessageToBeExpandedInConv({conv:d,sourceFid:e.cfid||e.mfid,mid:t.messageId}),t.getDisplay&&n.getResponseByTag(O,i).success&&(a=n.getResponseByTag(O,i).result,a.forEach(function(e){var t=p.getDisplayMessage(O,e);S.store.cacheGDM(t,O==="display"?m:null),v.mid===t.mid&&(s.fullmsg=S.processBody(t))}),O==="display"&&S.translateMid(p.getDisplayMessage(O,a[0]),m),s.fullmsg||(s.fullmsg=S.processBody(p.getDisplayMessage(O,a[0]))));if(!s.fullmsg){r+=1,function(i,o){ct({showTAE:t.showTAE,statTAE:t.statTAE,midArray:[o.mid]}).sync().then(function(t){r-=1,t[O].get.forEach(function(e){if(e.success){var t=p.getDisplayMessage(O,e.result[0]);S.logGDMRetrySuccess(),S.store.cacheGDM(t,O==="display"?m:null)}else k&&e.yodaErrorCode==="remapped-display-get-EC-4001"&&(f=!0,S.logIdAge(l,e.yodaErrorCode))}),s.fullmsg=S.store.getMessage(e.cfid||e.mfid,{mid:o.mid}),c("success",i),r===0&&h()})}(d,v);return}c("success",d)}),r===0&&h()}),[{abort:function(){n&&n.cancelSync()}}]):[S.nextTick(function(){h()})]}function lt(t){return e.mail.controller.v3.api.getConversations({items:[{conversationId:t.conversationId,cfid:t.cfid,mfid:t.mfid,force:t.force,messageId:t.messageId,newMsg:t.newMsg,oldMsgCnt:t.oldMsgCnt||0}],success:function(e,n){if(e.length>0&&t.success){t.success(e[0]);return}n.length>0&&t.failure&&t.failure(n[0])},getDisplay:t.getDisplay,pane:t.pane,showTAE:t.showTAE})}function ct(e){var t=new r(e),n=(new a).id(e.midArray),i;return O==="simplebody"?i="$.id":(n.fetchV2Mid(),i="$.oldSearchV2Mid"),t.messages.pipe(n,{typeName:"messages",serialize:function(){return{iterator:"$..messages[*]",select:{mid:i}}}}),t[O].get((new v({name:O,messageId:"$(mid)",expandCIDReferences:A})).showFull().tag("requesttranslatecode")),t.closePipe(),t}function ht(e){var t,n=!0,i=e.yoda,o=e.isPrefetchCall||!1,u=e.sourceFid,f=!!e.sameTick,l=f?S.sameTick:S.nextTick,c=e.filter||{},h=S.pluck(e.messageList,"mid"),d=[],m=[],g=!1,y=e.success||function(){},b=S.idAge(h),w=function(e,t){var n;O==="display"&&S.translateMid(p.getDisplayMessage(O,e.result[0]),t),n=p.getDisplayMessage(O,e.result[0]),d.push(S.processBody(n)),S.store.cacheGDM(n,O==="display"?t:null)},x=function(){var n;m.length===0?(s.matchOrder("mid",e.messageList,d),y(d,m,g),t=null):(n=m.map(function(e){return e.mid}),t=ct({showTAE:e.showTAE,statTAE:e.statTAE,actionTitle:"getMessageV2Mid",midArray:n}),T(t).then(function(r){m=[],r[O].get.forEach(function(e,t){e.success?(S.logGDMRetrySuccess(),w(e,n)):(m.push({mid:n[t]}),k&&e.yodaErrorCode==="remapped-display-get-EC-4001"&&(S.logIdAge(b,e.yodaErrorCode),q()))}),s.matchOrder("mid",e.messageList,d),y(d,m,g),t=null}))};return e.useCache===!1&&(n=!1),e.yoda?t=e.yoda:t=new r({statTAE:e.statTAE,showTAE:e.showTAE,actionTitle:"getMessage"}),e.messageList.forEach(function(r){var i=S.store.getMessage(u,r),s=i&&i.body,f=i.isTruncated,l=c.truncateAt===null,h=i.hasBlockedImages,p=c.midRequest&&c.midRequest.blockImages==="none"||e.blockImages==="none",m=!l||!f,g=!p||!h,y=!!(s&&m&&g),b=n&&y,w,x=new a;p&&(e.blockImages="none"),b?d.push(i):(w=new v({name:O,messageId:r.mid,expandCIDReferences:A}),w.blockImages(e.blockImages?e.blockImages:S.getBlockedImageSetting(u,r)),w.setFid(u).setFilter(c),e.tag?w.tag(e.tag+"-optional"):w.tag("-optional"),t[O].get(w));if(R&&r.decos&&r.decos.some(U)&&r.cardConversationId&&!E.isCached(r.cardConversationId)){var T=[];T.push(r.cardConversationId),x.cardConversationId(T),t.cardConversations.get(x)}S.splunkLog({name:"gdm_cache",isHit:b||!1,isPrefetchCall:o},"sample")}),i?d:t.hasItemToSync()?(T(t).then(function(t){R&&t[M]&&t[M].get&&t[M].get.forEach(function(e){e.success&&E.setCardConversation(e.result,"Coupon",!0),g=g||!!e.abort}),t[O].get.forEach(function(t,n){t.success?w(t,h):m.push({mid:e[n]||e.messageList[n]&&e.messageList[n].mid}),g=g||!!t.abort}),x()}),[{abort:function(){t&&t.cancelSync()}}]):[l(function(){x()},function(){g=!0,x()})]}function pt(){var e="1",t="2",n="3",s=i.settings.value("resetUnseenAPIMode",e),o=new r({actionTitle:"resetUnseen",statTAE:!1,showTAE:!1});W().then(function(e){switch(s){case n:dt(o,e);break;case t:dt(o,e)}N(o)})}function dt(e,t){var n=(new c).selectInbox(),r;r=new h({decosSelector:n}),t.forEach(function(e){r.resetUnseen(e)}),e.decos.update(r)}function vt(e){var t=Date.now(),n;if(j&&B>=P&&t-j<H)return!1;if(!j||j&&t-j>=H)j=Date.now(),B=0;B++,e.options.showTAE=!1,e.options.statTAE=!1;switch(e.type){case"message":ht(e.options);break;case"conversations":ft(e.options);break;case"convlist":case"msglist":if(e.options.fid){n=b.get(e.options.fid,"total");if(n<=0||!y.isEnabledForFid(e.options.fid)||y.isCached(e.options.fid))return!1}i.isEmpty(F)||(e.options.groupBy=F.groupBy,e.options.sortKey=F.sortKey,e.options.sortOrder=F.sortOrder),e.options.success=function(t){y.set(e.options.fid,e.type==="convlist"?t.convInfo:t.messageInfo)},e.type==="convlist"?ot(e.options):ut(e.options)}}function mt(e){var t,n,s;s=new 
r({actionTitle:"getAttributes",statTAE:!1,showTAE:!1}),e.filters&&(t=new f,t=t.selectMessageFilters(),s.attributes.get(t)),e.blockSenders&&(n=new f,n=n.selectDeliveryBlockedSenders(),s.attributes.get(n)),x(s).then(function(t){var n={};t.attributes.get.forEach(function(t){t.success&&t.result&&t.result[0]&&t.result[0].value&&(t.result[0].value.filters&&e.filters?n.filters=t.result[0].value.filters:t.result[0].value.senders&&e.blockSenders&&(n.blockSenders=t.result[0].value.senders))}),i.isEmpty(n)||e.success&&e.success(n)})}function gt(e){var t=new r({actionTitle:"deleteAccount",statTAE:!0,showTAE:!1});t.accounts.remove(new l({typeName:"accounts",pathFromMailbox:"/accounts/@.id=="+e.accountId})).sync().then(function(t){i.isEmpty(t)||e.success&&e.success(t)})}function yt(e){var t=new r({actionTitle:"removeFwdEmailAddress",statTAE:!1,showTAE:!1});if(!e.accountId&&!e.accountType)return;t.accounts.update({typeName:"accounts",serialize:function(){return{url:(new l({typeName:"accounts",pathFromMailbox:"/accounts/@.id=="+e.accountId})).serialize(),postPayload:{account:{type:e.accountType,unsetFields:["forwardEmail","forwardSetting"]}}}}}).sync().then(function(t){i.isEmpty(t)||e.success&&e.success(t)})}function bt(e){var t=new r({actionTitle:"resendVerificationEmail",statTAE:!1,showTAE:!1});if(!e.accountId&&!e.accountType)return;t.accounts.update({typeName:"accounts",serialize:function(){return{url:(new l({typeName:"accounts",pathFromMailbox:"/accounts/@.id=="+e.accountId})).serialize(),postPayload:{account:{type:e.accountType,resendVerification:!0}}}}}).sync().then(function(t){i.isEmpty(t)||e.success&&e.success(t)})}function wt(t){var n=t.email,s=typeof t.success=="function"?t.success:function(){},o=typeof t.failure=="function"?t.failure:function(){},u=new r({actionTitle:"setDefaultSendingAccount",statTAE:!0,showTAE:!1});if(!(n&&typeof n=="string"&&n.indexOf("@")>0)){o({msg:"invalid email!"});return}return u.accounts.pipe(new l({typeName:"accounts",pathFromMailbox:"/accounts"}),{typeName:"accounts",serialize:function(){return{iterator:'$..accounts[?(@.email=="'+n+'")]',range:"[0]",select:{acctId:"$.id",type:"$.type"}}}}).accounts.pipe({typeName:"accounts",tagSuffix:"updateReq",serialize:function(){return{url:(new l({typeName:"accounts",pathFromMailbox:"/accounts/@.id==$(acctId)"})).serialize(),postPayload:{account:{type:"$(type)",isSending:!0}}}}}).accounts.get(new l({typeName:"accounts",pathFromMailbox:"/accounts"})).closeAllPipe().sync().then(function(t){var r=u.getResponseByTag("accounts","updateReq");r.success?(yui.fire("imapin:accountRefreshed",t.accounts.get[0].result),(i.features.enabled("isUserDataMigrated")||NeoConfig.forceToV3UserSetting)&&e.mail.controller.v3.settings.userSettings.ingest("accounts.defaultFromAddress",n),s(r)):o(r)})}function Et(e,t){return function(n){return S.preCheckProceed(n,t)?e.call(null,n):(setTimeout(function(){n.failure&&n.failure()},0),null)}}function St(t){var n=new r({actionTitle:"cardConversations"}),i=t.cardConversationIds,s=new a;if(!e.Lang.isArray(i)||i.length<=0){t.failureCallback({error:"cardconvids_empty"});return}s.cardConversationId(i),n.cardConversations.get(s),n.sync().then(function(e){e.cardConversations.get[0].success?t.successCallback(e.cardConversations.get[0].result):t.failureCallback({error:"req_failed",response:e.cardConversation.get[0]})},function(e){t.failureCallback(e)})}function xt(e){var t=new r({actionTitle:"getUnseenCount",statTAE:!0,showTAE:!1}),n=[],i=0;return t.decos.get(new c).sync().then(function(r){var s=r.decos.get[0];if(!s.success){e.failureCallback(s),t=null;return}n=s.result.filter(function(e){return e.id==="FTI"}),n[0]&&n[0].counts&&(i=n[0].counts.filter(function(e){return e.accountId===w.getPrimaryAccount().id}).map(function(e){return e.unseen})[0]||0),e.successCallback({unseenCount:i}),t=null}),{abort:function(){if(t)return t.cancelSync()}}}var t=e.mail,n=e.Mail,r=n.Api.Yoda,i=e.common.Utils,s=e.mail.api.utility,o=t.Controller.Folders,u=t.Controller.ImapIn,a=n.Api.MessageSelector,f=n.Api.AttributeSelector,l=n.Api.BaseSelector,c=n.Api.DecosSelector,h=n.Api.DecosUpdater,p=t.controller.v3.converter,d=n.Api.MessageUpdater,v=n.Api.DisplaySelector,m=t.model.DataStore.Messages,g=t.model.ConvStore.Conversations,y=t.model.ListStore.ListCache,b=t.model.DataStore.Folders,w=t.model.DataStore.Accounts,E=t.model.DataStore.CardConversations,S=t.controller.v3.helper,x=S.createYodaSyncDebouncer(500),T=S.createYodaSyncDebouncer(1e3),N=S.createYodaSyncDebouncer(1e4),C=S.iterators,k=i.features.enabled("checkmailAfterMessageFailsToLoad"),L=i.features.enabled("explicitFolderExclusion"),A=!i.features.enabled("expandInlineAttachedImageUrlOnClient"),O=i.features.enabled("getSimpleBody")?"simplebody":"display",M="cardConversations",_=3e3,D=200,P=50,H=3e5,B=0,j=0,F={},I=[],q=i.debounce(function(){o.triggerCheckMail(0)},1e3),R=i.isEligibleForCoupons(),U=function(e){return e&&e.id&&e.id==="CPN"};z.prototype={flagMessagesWithMid:Et(Y,"flag"),moveMessagesWithMid:Et(Z,"move"),deleteMessagesWithMid:Et(et,"remove"),flagConversationsWithCid:Et(tt,"flag"),moveConversationsWithCid:Et(nt,"move"),deleteConversationsWithCid:Et(rt,"remove"),updateMessagesWithFid:Et(it,"folder"),getConvList:Et(ot,"convlist"),getMsgList:Et(ut,"msglist"),getConversation:Et(lt,"getconv"),getConversations:Et(ft,"getconvs"),getSimpleBodyofMessages:Et(ht,"getmessage"),resetUnseen:Et(pt,"resetUnseen"),getUnseenCount:Et(xt,"getUnseenCount"),hoverPrefetch:Et(vt,"hoverPrefetch"),setDefaultSendingAccount:Et(wt,"setDefaultSendingAccount"),deleteAccount:Et(gt,"deleteAccount"),resendVerificationEmail:Et(bt,"resendVerificationEmail"),removeFwdEmailAddress:Et(yt,"removeFwdEmailAddress"),getAttributes:Et(mt,"getAttributes"),updateDecosWithMid:Et(G,"updateDeco"),getCardConversations:Et(St,"getcardconvs")},e.namespace("mail.controller.v3").api=new z},"1.0.0",{requires:["mail-model-datastore","mail-model-convstore","mail-model-liststore","mail-api-yoda","mail-api-attribute-selector","mail-api-message-selector"
,"mail-api-display-selector","mail-api-message-updater","mail-controller-v3-helper","mail-api-decos-selector","mail-api-decos-updater","mail-controller-v3-converter","mail-api-folder-selector","mail-controller-folders","mail-controller-imapin","mail-ui-folder-utils","mail-api-utility","mail-common-utils-settings","mail-common-utils-features"]});
