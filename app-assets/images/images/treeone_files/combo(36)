YUI.add("_shared_module_offscreen_bin_contacts_hovercard_mini",function(e){e.namespace("ui.Templates"),e.ui.Templates._shared_module_offscreen_bin_contacts_hovercard_mini={base:"<div class='hovercard-arrow'> <div class='inner'></div></div><div id=\"hovercard\" class=\"mini\"> {{contact_item}}</div>",profile_photo:'<div class="image" style="background-image: url({{image_url}}/v4/contacts/{{id}}/photo?wssid={{wssid}}&appid={{appid}}&spsize=72X72&badge=true&u={{updated}}&y-dc=hc-{{buildNumber}})"></div> ',_name:'<div class="name"> <span>{{name}}</span> </div> ',_email:'<div class="title" > <span>{{email}}</span> </div> ',_title:'<div class="title"> <span>{{title}}</span> </div> ',contact_item:'<div class="item"> <div class="line"></div> <div class="image icon-attendee"> {{profile_photo}} </div> <div class="bd"> {{_name}} {{_email}} {{_title}} </div> </div> '}},"1.0.0");
YUI.add("contacts-ui-hovercard-plugin",function(e){var t,n=e.common.Utils,r=e.mail,i=e.ui.Templates,s=n.substitute,o=n.escapeHtml,u=n.unescapeHtml,a=n.convertToBoolString,f=r.ui.HoverCardDataStore,l=r.persist.MetaData,c=r.common.ConnectedAccounts,h=i._shared_module_offscreen_bin_contacts_hovercard,p=i._shared_module_offscreen_bin_contacts_hovercard_mini,d={regular:i._shared_module_offscreen_bin_contacts_hovercard,mini:i._shared_module_offscreen_bin_contacts_hovercard_mini},v=["mini","regular"],m="menu-active-item",g=null,y=[],b=e.xobniContacts.isXobnified(),w=e.xobniContacts.searchAPI;t=e.Base.create("hovercard",e.Widget,[e.WidgetPosition,e.WidgetStack,e.WidgetPositionConstrain],{mouseMoveTimeout:null,initializer:function(){var e=this;e._hcardSelectors=".message-item-header .hcard, .thread-item-header .hcard, .compose-header .hcard",e._currTrigger={node:null,dataAddress:null,contactsData:[],cardSize:null,mouseX:t.OFFSCREEN_XY[0],mouseY:t.OFFSCREEN_XY[1]},e._eventHandles={delegateEnter:null,delegateLeave:null},e._timers={show:null,hide:null,offscreen:null}},bindUI:function(){var t=this;t._bindDelegate(),e.on("lozenge:highlight",function(){t._hideHoverCard()}),e.on("lozenge:remove",function(){t._hideHoverCard()}),e.on("HoverCard:hideHoverCard",function(){t._hideHoverCard()})},syncUI:function(){var e=this;e.get("boundingBox").setStyles({position:"absolute"})},_bindDelegate:function(){var t=this,n=t._eventHandles,r=e.one("#shellcontent");n.delegateEnter&&(n.delegateEnter.detach(),n.delegateEnter=null),n.delegateLeave&&(n.delegateLeave.detach(),n.delegateLeave=null),n.delegateEnter=r.delegate(["mouseenter","mousedown"],e.bind(t._onNodeMouseEnter,t),t._hcardSelectors),n.delegateLeave=r.delegate("mouseleave",e.bind(t._onNodeMouseLeave,t),t._hcardSelectors)},setTriggerContent:function(t){var n=this,r=n._currTrigger,i=r.cardSize,s=n.get("contentBox"),o;e.Lang.isUndefined(b)&&(b=e.xobniContacts.isXobnified());if(i===v[0]||i===v[1]&&r.dataAddress===t[0].email)r.contactsData=t,s.set("innerHTML",""),o=n._getHoverCardMarkup(),s.appendChild(o),n._showHoverCard(),n._bindContentBoxUI(),i===v[1]&&t[0].id&&n.setProfilePhotoHandler()},_onNodeMouseEnter:function(t){var n=this,r=t.currentTarget;t.halt(),n._clearTimers();if(r.get("parentNode").hasClass("focus")||r.hasClass("lozenge-error")){n._hideHoverCard();return}n._triggerNodeChanged(t)?(n._hideHoverCard(),n._toggleTitleAttr(r,!0),clearTimeout(n.mouseMoveTimeout),e.fire("hideHoverCardCallout"),t.type==="mousedown"?r.hasClass("cl")||n._showCard(r,t.pageX,t.pageY):n.mouseMoveTimeout=setTimeout(function(){n._showCard(r,t.pageX,t.pageY)},400)):t.type==="mousedown"&&!r.hasClass("cl")&&(r.hasClass("active")?n.hideHoverCard():n._showCard(r,t.pageX,t.pageY))},_showCard:function(e,t,n){this._clearTimers(),this._clearHandles(),this._setOffscreenTimer(),this._setCurrentTrigger(e,t,n)},_triggerNodeChanged:function(e){var t=this,n=e.currentTarget,r=t._currTrigger.node,i=n&&n.getAttribute("data-address");return i?r?i===t._currTrigger.dataAddress&&n.getY()===r.getY()?!1:!0:!0:!1},_onNodeMouseLeave:function(t){var n=this,r=t.currentTarget;n._setNodeActive(!1),n._toggleTitleAttr(r,!1),clearTimeout(n.mouseMoveTimeout),n._timers.hide=e.later(n.get("delay.hide"),n,n._hideHoverCard)},_onNodeMouseMove:function(e){var t=this;e.halt(),t._currTrigger.mouseX=e.pageX,t._currTrigger.mouseY=e.pageY},_toggleTitleAttr:function(t,n){var r=e.mail.Tabs.getActiveTab().elContent,i=r&&r.all("[title]"),s="title",o="title-off",u,a,f;n?(u=o,a=s):(u=s,a=o),i&&i.each(function(e){f=e.getAttribute(a),f&&(e.setAttribute(a,""),e.setAttribute(u,f))})},_showHoverCard:function(){var n=this,r=n._currTrigger,i=r.node,s=i.hasClass("cl"),o=i.hasClass("more"),u=i&&i.get("parentNode").hasClass("focus"),f,l;f=n._getXYForPosition(),f&&!u&&(n.move(f[0]+t.OFFSET_XY[0],f[1]+t.OFFSET_XY[1]),(s||o)&&n._track("view","hvrCrd"),e.fire("util:ymstats",{name:"hovercard",tags:{size:r.cardSize,isCorp:a(NeoConfig.isCorpmail)}}),r.cardSize===v[1]&&(l=r.contactsData[0],e.fire("util:ymstats",{name:"hovercard_name",tags:{name:l.name===l.email?"email":"name",xuser:a(b),xcontact:a(l.id),isCorp:a(NeoConfig.isCorpmail)}}),e.fire("util:ymstats",{name:"hovercard_tel",tags:{phone:a(l.phone),xuser:a(b),xcontact:a(l.id),isCorp:a(NeoConfig.isCorpmail)}}),e.fire("util:ymstats",{name:"hovercard_linkedin",tags:{linkedin:a(l.linkedin),xuser:a(b),xcontact:a(l.id),isCorp:a(NeoConfig.isCorpmail)}}),e.fire("util:ymstats",{name:"hovercard_flickr",tags:{flickr:a(l.flickr),xuser:a(b),xcontact:a(l.id),isCorp:a(NeoConfig.isCorpmail)}})),e.ACWidgetInst&&e.ACWidgetInst.hide(),n.show(),n._clearOffscreenTimer())},_getXYForPosition:function(){var t=this,n=t.get("boundingBox"),r=n.one(".hovercard-arrow"),i=e.one("html"),s=strings.str_tog_loadRTLCss?!0:!1,o=t._currTrigger,u=o.node,a,f,l,c,h,p,d,v,m;if(u){f=o.mouseX,l=o.mouseY,a=u.getXY(),c=u.get("clientHeight"),h=u.get("clientWidth"),v=n.get("clientWidth")-20,m=n.get("clientHeight")-20;if(a[0]&&a[1])return p=i.get("clientWidth"),d=i.get("clientHeight"),s?f>v?(f=h<30?a[0]+10:a[0]-10,f=f+h-v):(f=h<30?a[0]-30:a[0]-10,r&&r.setStyle("right",v-30+"px")):(f=h<30?a[0]-30:a[0]-10,p-f<v&&(f=a[0]+h-v,r&&r.setStyle("left",v-30+"px"))),d-l<m?(l=a[1]-c-m,r.addClass("down")):(r.removeClass("down"),l=a[1]+20),[f,l]}return!1},_hideHoverCard:function(){var e=this;try{e._currTrigger.dataAddress&&(e._toggleTitleAttr(e._currTrigger.node,!1),e.hide(),e._setNodeActive(!1),e._clearCurrentTrigger(),e._clearTimers(),e._setOffscreenTimer())}catch(t){typeof globals!="undefined"&&globals.report?globals.report("caughterror:..-build-contacts-ui-hovercard-hovercard-plugin:1",t,"TRY_CATCH",1,1,1):window.console&&console.log&&console.log("caughterror:..-build-contacts-ui-hovercard-hovercard-plugin:1")}},_setNodeActive:function(e){var t=this,n=t._currTrigger.node,r=t._currTrigger.cardSize;r===v[1]&&n&&n.getDOMNode()&&n.toggleClass("active",e)},hideHoverCard:function(){this._hideHoverCard()},_setOffscreenTimer:function(){var t=this,n=t._timers;t
._clearOffscreenTimer(),n.offscreen=e.later(t.get("delay.offscreen"),t,t._moveOffscreen)},_moveOffscreen:function(){this.get("boundingBox").setStyles({top:t.OFFSCREEN_XY[0]})},_clearOffscreenTimer:function(){var e=this._timers;e.offscreen&&e.offscreen.cancel()},_setCurrentTrigger:function(t,n,r){var i=this,s=i._currTrigger,o,u,a=[],l,c;u=t.getAttribute("data-name"),o=t.getAttribute("data-address"),l=t.hasClass("cl"),c=t.hasClass("more"),s.mouseX=n,s.mouseY=r,s.node=t,s.dataAddress=o,c?(s.cardSize=v[0],o=o.split(","),e.Array.each(o,function(e){a.push({name:e,email:e,isCompose:l})})):(s.cardSize=v[1],a.push({name:u,email:o,isCompose:l})),i._setNodeActive(!0),g&&clearTimeout(g),g=setTimeout(function(){f.load(a,e.bind(i.setTriggerContent,i))},0),!c&&!l&&(i._track("view","hvrCrd"),i.setTriggerContent([{name:u,email:o,isCompose:l,card_size:0,endpoints:[]}]))},_clearCurrentTrigger:function(){var e=this,t=e._currTrigger,n;t.node&&(n=t.node,t.node=null,t.dataAddress=null,e._clearHandles())},_clearTimers:function(){var e=this._timers;e.hide&&(e.hide.cancel(),e.hide=null)},_clearHandles:function(){var t;for(t in y)e.detach(y[t]);y=[]},_getHoverCardMarkup:function(){var t=this,r=t._currTrigger.contactsData,f=t._currTrigger.cardSize,l=f===v[0]?r:r[0],h=d[f],p,m=function(t){var n=e.contacts&&e.contacts.utils.getContactsByEmail(t)||[!1];return n[0]&&n[0].id>=0?n[0].id:!1};return p={_name:function(e,t,n){return e.name?(e.name=o(u(e.name)),s(h._name,e,null,null,strings)):""},_title:function(e,t,n){return e.title?(e.title=o(u(e.title)),s(h._title,e,null,null,strings)):""},_email:function(e,t,n){return f===v[1]||f===v[0]&&!e.title?(e.email=o(u(e.email)),s(h._email,e,null,null,strings)):""},_phone:function(e,t,r){return e.phone?(e.phone=o(u(e.phone)),e.isElcaro===!0?(e.phone_source=strings.str_hovercard_phone_src,e.phone_style=n.features.enabled("highlightElCaro")===!0?"elcaro":""):e.phone_source="",s(h._phone,e,null,null,strings)):""},add_contact:function(e,t,n){return m(e.email)===!1?s(h.add_contact,e,null,null,strings):""},edit_card:function(e,t,n){return e.id?s(h.edit_card,e,null,null,strings):""},_backyard:function(e,t,n){return e.corpId&&NeoConfig.isCorpmail?s(h._backyard,e,null,null,strings):""},_linkedin:function(t,n,r){return t.linkedin?(e.fire("util:ymstats",{name:"hovercard_linkedin_rendered"}),t.linkedin=o(u(t.linkedin)),s(h._linkedin,t,null,null,strings)):""},_flickr:function(e,t,n){return e.flickr?(e.flickr=o(u(e.flickr)),s(h._flickr,e,null,null,strings)):""},upsell_link:function(t,n,r){var i,o=c.getUpsell(),u=o==="linkedin"&&c.forceReconnect();return o&&b===!0&&t.isKnownEntity===!1&&t.isMachineGenerated===!1?(i={service:o,logo:"logo-"+o,label:u?strings.str_reauthorize:strings.str_hovercard_get_photos,reconnect:u?"reconnect":""},e.fire("util:ymstats",{name:"hovercard_action",tags:{action:o+"_showUpsell",isCorp:a(NeoConfig.isCorpmail),reconnect:u}}),s(h.upsell_link,i,null,n,strings)):""},profile_photo:function(e,t,n){return e.id?s(h.profile_photo,e,null,null,strings):""},contact_item:function(n,r,a){var f="";return e.Array.each(n,function(e){e.name=o(u(e.name)),f+=s(h.contact_item,e,p,{},strings,i,t)}),f}},l.name&&(l.name=o(u(l.name))),s(h.base,l,p,{},strings,i,t)},_bindContentBoxUI:function(){var t=this,r=t._currTrigger.contactsData[0],i=t.get("boundingBox"),s=t._currTrigger,o=s.node,u,f,l,c;t._clearHandles(),o&&(f=o.ancestor(".thread-item-list"),y.push(e.one("document").on("keydown",e.bind(function(e){e.keyCode!==67&&!e.ctrlKey&&!e.metaKey&&t._hideHoverCard()},t))),y.push(i.on("mouseenter",e.bind(function(e){var t=this;t._setNodeActive(!0),t._clearTimers()},t))),y.push(i.on("mouseleave",e.bind(function(t){var n=this,r=t.target.ancestor(".clipboard");r||(n._clearTimers(),n._timers.hide=e.later(n.get("delay.hide"),n,n._hideHoverCard))},t))),y.push(o.on("mousemove",e.bind(t._onNodeMouseMove,t))),f&&y.push(f.on("scroll",e.bind(t._hideHoverCard,t))),s.cardSize===v[1]&&(u=i.one(".upsell"),y.push(i.one(".more").on("mouseenter",e.bind(function(n){i.all("li."+m).removeClass(m),i.one(".menu-more").setStyle("display","block"),e.fire("util:ymstats",{name:"hovercard_action",tags:{action:"more",isCorp:a(NeoConfig.isCorpmail)}}),t._setupClipBoard()},t),t)),y.push(i.one(".footer").on("mouseleave",function(e){var t=e.target.ancestor(".clipboard");t||i.one(".menu-more").setStyle("display","none")})),y.push(i.one(".menu-more").delegate("mouseenter",e.bind(function(e){i.all("li."+m).removeClass(m)},t),"li")),y.push(i.delegate("click",function(r){l=n.getDataAction(r),c=l.action,r.halt(),t._handleAction(l),c!=="more"&&c!=="upsell-hide"&&t._hideHoverCard(),c!=="more"&&c!=="upsell-connect"&&c!=="upsell-hide"&&e.fire("util:ymstats",{name:"hovercard_action",tags:{action:c,isCorp:a(NeoConfig.isCorpmail)}})},"*[data-action]")),u&&r.id&&y.push(i.one("#upsellImg").on("error",function(e){u.hasClass("reconnect")||u.removeClass("hidden")}))),s.cardSize===v[0]&&y.push(o.on("click",e.bind(t._hideHoverCard,t))))},_handleAction:function(t){var n=this,i=n._currTrigger.node,s=n._currTrigger.contactsData[0],o="click";switch(t.action){case"new-message":if(!i.hasClass("cl")){var u={cbfn:function(e){var t={};return t.to=[{name:s.name,email:s.email}],e.setHeader(t),!0}};e.fire("newMessage",u),n._track(o,"hvrCrdNewMsg")}break;case"add-contact":e.use("contacts-ui-hovercard-addedit",function(e){(new r.ui.HoverCardAddEdit({action:"addContact",data:s})).show()}),n._track(o,"hvrCrdAddCntct");break;case"edit-card":e.use("contacts-ui-hovercard-addedit",function(e){(new r.ui.HoverCardAddEdit({action:"editCard",data:s})).show()});break;case"search-msg":e.fire("search:fireSearch",{suggestion:{displayStr:s.email,emailAddresses:[s.email]},typeTag:"hovercard_search_email"}),n._track(o,"hvrCrdSrchMsg");break;case"backyard":e.use("mail-common-corpmail",function(e){r.common.corpmail.showBackyardProfile(s.corpId)}),n._track(o,"hvrCrdLnkBkyrd");break;case"linkedin":e.fire("util:ymstats",{name:"hovercard_linkedin_clicked"}),window.open(s.linkedin_url);break;
case"flickr":window.open(s.flickr_url);break;case"upsell-connect":n._openUpsell(t.node);break;case"upsell-hide":n._hideUpsell(t.node);break;case"open-img-src":var a=t.node.getAttribute("data-value");n._openImageSrc(a)}},setProfilePhotoHandler:function(){var t=this,n=t._currTrigger.contactsData[0],r=t.get("boundingBox"),i=r.one("#hcardProfileImg"),s={linkedin:strings.str_hovercard_linkedin_profile,corpdir:strings.str_hovercard_backyard_profile,flickr:strings.str_hovercard_flickr_profile},o=function(t){t!==!1&&(n.photoSrc=t,["linkedin","flickr","corpdir"].indexOf(t)>-1&&(i.setAttribute("data-value",t),i.setAttribute("title",s[t]),i.setStyle("cursor","pointer"),t==="linkedin"&&r.one(".upsell.reconnect")&&(i.ancestor(".icon-attendee").addClass("reconnect"),r.one(".upsell").removeClass("hidden")))),e.fire("util:ymstats",{name:"hovercard_imgsrc",tags:{src:t,isCorp:a(NeoConfig.isCorpmail)}})};e.Lang.isUndefined(n.photoSrc)?w.photo(n,e.bind(o,t)):o(n.photoSrc)},_openImageSrc:function(t){var n=this,i=n._currTrigger.contactsData[0],s;if(t){switch(t){case"corpdir":e.use("mail-common-corpmail",function(e){r.common.corpmail.showBackyardProfile(i.corpId)});break;case"linkedin":e.fire("util:ymstats",{name:"hovercard_linkedin_clicked"}),window.open(i.linkedin_url);break;case"flickr":window.open(i.flickr_url)}e.fire("util:ymstats",{name:"hovercard_imgClkSrc",tags:{src:t,isCorp:a(NeoConfig.isCorpmail)}})}},_setupClipBoard:function(){var t=this,n,r=t._currTrigger.contactsData[0],i=t.get("contentBox"),s=t.get("contentBox").all(".clipboard");e.use("swfdetect","comms-ui-clipboard-plugin",function(e){e.SWFDetect.isFlashVersionAtLeast(10,1,0)&&(n=e.comms.ui.ClipBoard,s.each(function(s){s instanceof e.Node&&s.plug(n,{moviepath:NeoConfig.copySwfMoviePath}).on("clipboard:load",function(){var n=this;n.removeClass("disabled"),n.on("mouseenter",function(e){this.hasClass("copy-email")?this.setAttribute("copy",r.email):this.setAttribute("copy",[r.name,r.title,r.email,r.phone].join("\n"))},n),n.on("mouseleave",function(e){n.removeClass(m)},n),n.clipboard.setEvent("click",e.bind(function(e){n.clipboard.hide(),t.hideHoverCard()},n),!0),n.clipboard.setEvent("mouseOver",function(e){i.all("li."+m).removeClass(m),n.addClass(m),n.focus()}),e.on("HoverCard:hideHoverCard",function(){n.clipboard.removeEvent("mouseOver"),n.clipboard.removeEvent("click"),n.clipboard.hide()})})}),e.on("clipboard:error",function(e){s.addClass("disabled")}))})},_openUpsell:function(t){var n=t.getData("value");n&&(c.linkTo(n),e.fire("util:ymstats",{name:"hovercard_action",tags:{action:n+"_openUpsell",isCorp:a(NeoConfig.isCorpmail)}}))},_hideUpsell:function(t){var n=t.getData("value");return e.fire("util:ymstats",{name:"hovercard_action",tag:{action:n+"_hideUpsell",isCorp:a(NeoConfig.isCorpmail),reconnect:t.hasClass("reconnect")}}),t.ancestor(".upsell").remove(),c.hideUpsell(n)},_track:function(t,n){var r,i=t==="view"?"mt:view":"mt:click",s;r=e.mail.Tabs.getActiveTab().get("widget").type;switch(r){case"author":s="cmps";break;case"convpane":case"convlist":s="thrdRd";break;case"messagepane":case"messagelist":s="msgRd"}e.fire(i,{action:s+"_"+n})}},{OFFSCREEN_XY:[-1e4,-1e4],OFFSET_XY:[0,0],ATTRS:{shim:{value:!1},render:{value:!0},trigger:{value:".hcard"},zIndex:{value:100},delay:{value:{show:100,hide:300,auto:1e3,offscreen:0}},xy:{value:[-1e4,-1e4]},constrain:{value:!0}}}),e.namespace("mail.ui"),e.mail.ui.HoverCard=t},"0.0.1",{requires:["node","widget","widget-position","widget-position-constrain","widget-stack","event-mouseenter","common-utils","comms-utils","contacts-ui-hovercard-datastore","mail-common-connected-accounts","hovercard-ult","isXobnifiedCheck","xobni-contacts-search-api","mail-common-utils-settings","mail-common-utils-features","_shared_module_offscreen_bin_contacts_hovercard","_shared_module_offscreen_bin_contacts_hovercard_mini","hovercard_css"]});
