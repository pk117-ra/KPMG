YUI.add("comms-ui-autocomplete-plugin",function(C){var B="autocomplete",F=C.Lang,G=C.Array.each,L=C.Plugin,E=L.Base,I="ac",D=13;function J(O,Q){var N="down",P=C.stamp(this)+"|";if(C.UA.gecko>0&&C.UA.gecko<5){N="press";C.on(P+"key",O.raiseFlag,Q,"down",O);}C.on(P+"valueChange",H,Q,O);C.on(P+"key",O.next,Q,N+":40",O);C.on(P+"key",O.previous,Q,N+":38",O);C.on(P+"key",O.close,Q,"down:27",O);Q.on("keyup",function(R){if(R.keyCode===D){R.type="select";this.select.call(O,R);}},O,"select");}function H(O){var N=O.newVal;if(!N&&!(N===""&&this.get("minQueryLength")===0)){this._cachedValue=false;return this.close();}if(N===this._cachedValue||N.length<this.get("minQueryLength")){return false;}this._cachedValue=N;this.fire("ac:query",{value:O.newVal});return true;}function A(N){return function(){if(N){N.setAttribute(B,"on");}N=null;};}function K(N){var P=C.Node.getDOMNode(N),Q=P.getAttribute(B);if((Q&&Q!=="off")||Q===null||Q===undefined){var O=A(P);C.on("beforeunload",O,window);C.on("unload",O,window);}P.setAttribute(B,"off");}function M(){M.superclass.constructor.apply(this,arguments);}C.extend(M,E,{_defaultEventFn:null,initializer:function(){var N=this,O=N.get("host"),P=(!F.isNull(N._defaultEventFn)?N._defaultEventFn:{});J(N,O);G(["query","load","show","hide","next","previous","select"],function(Q){N.publish("ac:"+Q,{broadcast:1,bubbles:1,context:N,preventable:true,prefix:I,defaultFn:P[Q]||null});},N);K(O);},destructor:function(){var N=this;C.detach(C.stamp(N)+"|");N.detachAll();},open:function(){this.fire("ac:show");},next:function(N){if(this.conflictingKeyFlag&&C.UA.gecko){return;}N.preventDefault();this.fire("ac:next");},previous:function(N){if(this.conflictingKeyFlag&&C.UA.gecko){return;}N.preventDefault();this.fire("ac:previous");},raiseFlag:function(O,N){if((O.keyCode===55)||(O.keyCode===57)){N.conflictingKeyFlag=true;}else{N.conflictingKeyFlag=false;}},select:function(N){this.fire("ac:select",N);},hide:function(){},close:function(){this.fire("ac:hide");},reload:function(N){if(N){if(N.length<1){this.set("badResult",this.get("queryValue"));}this.fire("ac:load",{results:N,query:this.get("queryValue")});}}},{NAME:"ACPlugin",NS:I,ATTRS:{queryValue:{getter:function(){return this.get("host").get("value");},setter:function(N){this.get("host").set("value",N);this._cachedValue=N;return this._cachedValue;}},dataSource:{value:[]},minQueryLength:{value:0,validator:F.isNumber},queryTemplate:{value:encodeURIComponent,setter:function(N){return(F.isFunction(N)?N:function(O){return N.replace(/(^|[^\\])((\\{2})*)\{query\}/,"$1$2"+encodeURIComponent(O)).replace(/(^|[^\\])((\\{2})*)\\(\{query\})/,"$1$2$4");});}},alignNode:null,conflictingKeyFlag:false,badResult:{value:false,setter:function(N){return(C.Lang.isString(N))?N:false;}}}});C.namespace("comms.ui");C.comms.ui.AutoCompleteEventsPlugin=M;},"1.0.0",{requires:["node","plugin","event-valuechange","event-key"]});YUI.add("comms-ui-autocomplete",function(C){var H=C.Array.each,F=C.Lang,B=C.Overlay,G="selectedIndex",A="queryValue",J="ac",D="_BOUND",I="_"+G,K="_originalValue";function E(){E.superclass.constructor.apply(this,arguments);this.delegated=false;this.listeners=[];}C.extend(E,B,{initializer:function(){var L=this;L.after({queryChanged:L.drawMarkUp,dataChanged:L.drawMarkUp});L.hide();L.publish(J+":complete",{broadcast:1,bubbles:1,context:L,preventable:true,prefix:J});},renderUI:function(){var M=this.get("ac"),L={"display":"none","overflow":"auto","maxHeight":"300px"};if(!M){return false;}this.get("contentBox").setStyles(L);this.get("contentBox").set("role","listbox");this.setSize();this.set("align",{node:this.get("ac").get("alignNode"),points:[C.WidgetPositionAlign.TL,C.WidgetPositionAlign.BL]});this.get("contentBox").setStyle("display","block");return true;},bind:function(P){var Q=this,L=Q.get("contentBox"),O=Q.get("ac"),N=C.stamp(Q)+"|";if(P&&O!==P&&Q[D]){C.detach(N);Q[D]=0;}P=P||O;if(P&&!Q[D]){var M=[];Q[D]=1;if(!Q.delegated){Q.delegated=true;M.push(L.delegate("click",Q.click,"li",Q));M.push(L.delegate("mouseover",Q.mouseover,"li",Q));M.push(L.delegate("mouseout",Q.mouseout,"li",Q));M.push(L.delegate("mousemove",function(R){R.halt();R.currentTarget.addClass("over");},"li",Q));M.push(L.delegate("mouseleave",function(R){R.halt();R.currentTarget.removeClass("over");},"li",Q));M.push(C.on("click",function(R){if(!Q.isVisible()){return;}if(Q.get("contentBox").contains(R.target)){if(R.target.get("nodeName").toLowerCase()!=="li"){return;}Q.get("ac").get("host").simulate("keydown",{keyCode:13});}if(Q.get("ac").get("host").contains(R.target)){return;}Q.hide();},document,this));}M.push(P.on(N+J+":load",function(R){if(!Q.get("disabled")){Q.setAttrs({query:R.query,data:R.results}).drawMarkUp().show().setAlign();}}));M.push(P.on(N+J+":query",function(R){Q.set("query",R.value).drawMarkUp();}));M.push(P.on(N+J+":next",Q.next,Q));M.push(P.on(N+J+":previous",Q.previous,Q));M.push(P.on(N+J+":hide",Q.hide,Q));P.select=function(R){Q.selected.call(Q,R,"enter");};Q.listeners=M;}return Q;},bindUI:function(L){return this.bind(L);},setSize:function(){if(!this.get("expandWidthToContents")){this.set("width",this.get("ac").get("alignNode").get("offsetWidth"));}},setAlign:function(){var O=this,M=O.get("ac").get("alignNode"),L=M.get("region"),N=[L.left,L.bottom];O.set("xy",N);return O;},drawMarkUp:function(){var L=this,M=L.get("data");if(!M){return L;}L[I]=-1;L[K]="";L.get("contentBox").set("innerHTML",L.getListMarkup(M));if(M.length>0){if(L.get("selectFirst")){this.set(G,0);}L.get("contentBox").setStyle("display","block");}else{L.get("contentBox").setStyle("display","none");}return L;},getListMarkup:function(O){var N=this,L=N.get("listTpl"),M=[];H(O,function(P){M.push(N.getItemMarkup(P));});return L.replace(/\{list\}/g,M.join(""));},getItemMarkup:function(M){var L=this;if(!F.isString(M)){return false;}return L.get("itemTpl").replace(/\{hilite\}/g,M);},_fixView:function(O){var R=this,N=R.get(G),L=R.get("contentBox"),Q,M,P;if(N===-1){L.set("scrollTop",0);return true;}M=R.item(N);Q=L.get("scrollTop");M=R.item(N);P=M.get("offsetTop");M.addClass("key-select");if(O){if((P>Q)&&(R.itemsCount()!==(N+1))){return true;}L.set("scrollTop",P);document.body.scrollIntoView();return false;}else{if((P+M.get("clientHeight"))>(Q+L.get("clientHeight"))){L.set("scrollTop",L.get("scrollTop")+M.get("clientHeight"));if(C.UA.ie<=0){M.scrollIntoView();}document.body.scrollIntoView(false);}return true;}},next:function(){var L=this;if(L.get("selectFirst")&&L.itemsCount()===1){return false;}return(L.get("visible")?L.selectNext():L);},selectNext:function(){var L=this;L.set(G,this.get(G)+1);L._fixView(false);return L.get(G);},selectPrevious:function(){var L=this;L.set(G,this.get(G)-1);L._fixView(true);return L.get(G);},previous:function(){var L=this;if(L.itemsCount()===1){return false;}return L.get("visible")?L.selectPrevious():L;},isVisible:function(){return this.get("visible");},hasSelectedItem:function(){return this.get("selectedIndex")>-1;},item:function(L){return this.get("contentBox").all(this.get("itemSelector")).item(L);},itemsCount:function(){return this.get("contentBox").all(this.get("allItemsSelector")).size();},click:function(L){this.selected(L,"click");},mouseover:function(O){var M,L,N=this;M=O.currentTarget;L=N.get("contentBox").all("li").indexOf(M);N.set("selectedIndex",L);},mouseout:function(){this.set("selectedIndex",-1);},autoManageSelect:function(L){var M=this,N=M.get("ac");if(!L){L=false;}if(L){N.on(J+":select",M.handleEnter,M);}else{N.detachAll(J+":select");}},handleEnter:function(P,M){if(!M){M=this;}var O=M.get("ac"),L=M[I],N,Q;P.halt();M.fire(J+":complete",M);if(L!==-1){N=M.item(L);if(N){Q=N.get("text");O.set(A,Q);}M[I]=-1;O.get("host").focus();M.hide();}},selected:function(R,P){var M=null,N=this,Q=N.get("ac"),L,O;if(!P){P="click";}M=N.item(this.get(G));if(!M){return false;}O=M.getData("selectedCb");if(O){O.call(M,R);return;}L=this.get(G);R.selectedItem=M;R.selectedIndex=L;R.type=P;R.container=N.get("contentBox");Q.fire("ac:select",R);N[I]=-1;return true;},setHostValue:function(M){var L=this;L.get("ac").set(A,M);L.get("ac").get("host").focus();L.hide();},reload:function(L){return this.get("ac").reload(L);},close:function(){var L=this;L.get("ac").close();L.hide();},destroy:function(){var M=this.listeners;if(M){var N=M.length,L;for(L=0;L<N;L++){if(M[L]){M[L].detach();M[L]=null;}}this.listeners=null;}if(this.get("ac")){this.get("ac").destructor();}E.superclass.destroy.apply(this,arguments);}},{NAME:"AutoCompleteWidget",ATTRS:{ac:{setter:function(L){if(!this[D]){return;}this.bind(L);},validator:function(){return true;}},data:{},query:{value:""},listTpl:{value:'<ul role="presentation">{list}</ul>'},itemTpl:{value:'<li role="option">{hilite}</li>'},itemSelector:{value:"ul li"},allItemsSelector:{value:"ul li"},selectedItem:{getter:function(){return this.item(this.get(G));},readOnly:true},expandWidthToContents:{value:false},selectFirst:{value:true}}});
E.ATTRS[G]={value:-1,validator:function(L){var M=this.get("data");return M&&C.Lang.isNumber(L);},getter:function(){return this[I];},setter:function(O){var T=this,Q=T.get(G),R=T.get("data"),L=T.itemsCount(),S=T.get("ac"),M=this.getClassName("selected"),P,N;if(isNaN(Q)){Q=-1;}if(!R||!L){return false;}while(O<-1){O+=L+1;}O=(O+1)%(L+1)-1;Q=(Q+1)%(L+1)-1;T[I]=O;if(Q===-1){T[K]=S.get(A);}if(Q===O){return false;}var U=T.get("contentBox").one("."+M);if(U){U.removeClass(M).removeClass("key-select");}if(O===-1){}else{P=T.item(O);if(P&&P.hasClass("corpmail.label")){N=O+(Q<O?1:-1);T[I]=N;P=T.item(N);}if(P){P.addClass(M);}}return O;}};C.namespace("comms.ui");C.comms.ui.AutoComplete=E;},"1.0.0",{requires:["overlay","comms-ui-autocomplete-plugin","node-event-simulate"]});YUI.add("filter-contacts",function(e){function h(){this.filterItems=[],this.matchType=1,this.init_temp_data=!0,this.del_temp_data=!0,this.match_limit=50}function b(e){var t,n,r,i=e.value;if(e.numeric){n=i.length;if(n>1){r=i.charAt(0),t=1;while(t<n)r+="[ _\\.\\-()]*",r+=i.charAt(t),t+=1}else r=i}else r=i;e.regExp=new RegExp(r,"gi")}function w(e,t){var n={};return n.value=e,v.test(e)||(n.numeric=!0),n.group_id=t,n.match_siIndex=-1,b(n),n}function E(e){var t,n,r,i,s,o,u=[];n=e.length;if(n===0)return u;var a=new RegExp("[ ]","g");for(t=0;t<n;t++){r=e[t],i=0;while(a.test(r))s=a.lastIndex-1,i<s&&(o=w(r.substring(i,s),t),u.push(o)),i=a.lastIndex;i<r.length&&(o=w(r.substring(i),t),u.push(o))}return u}function S(e){var t=[],n,r,i;if(e.length>0){i=new RegExp("[,;]","g"),n=0;while(i.test(e))r=i.lastIndex-1,r>n&&t.push(e.substring(n,r)),n=i.lastIndex;n<e.length&&t.push(e.substring(n))}return t}function x(e,t,n,r){var i,s,o,u,a,f,l,c,p;l=r.fuzzy_match_idx+1,f=r.fuzzy_matches;if(l<f.length)return a=f[l],r.fuzzy_match_idx=l,a;if(!r.fuzzy_complete){i=g,s=-1;for(;;){if(s===-1&&r.fuzzy_match_idx===-1)s=0;else{s<=0&&(i.lastIndex=r.fuzzy_match_idx===-1?0:f[r.fuzzy_match_idx].start+1);if(!i.test(e))break;s=i.lastIndex-1}u=r.matches;for(l=0,c=u.length;l<c;l++){o=u[l];if(s>o.start)break;if(s===o.start)return a={},a.start=o.start,a.end=o.end,a.diff=0,f.push(a),r.fuzzy_match_idx+=1,n.match_idx=a.end,a}c=n.value.length;if(c<=2){p=0;if(r.complete)continue}else c<=5?p=1:p=2;if((a=h.fuzzyMatch(n.value,e,s,p))!==null)return f.push(a),r.fuzzy_match_idx+=1,n.match_idx=a.end,a}r.fuzzy_complete=!0}return r.fuzzy_match_idx=-1,null}function T(e,t,n,r){var i,s,o,u,a,f;s=r.match_idx+1,f=r.matches;if(s<f.length)return a=f[s],r.match_idx=s,a;if(!r.complete){i=n.regExp,i.lastIndex=r.match_idx===-1?0:f[r.match_idx].start+1,o=i.lastIndex;while(i.exec(e)){if(t)return u=e.substring(o,i.lastIndex),o+=u.search(i),a={},a.end=i.lastIndex,a.start=o,f.push(a),r.match_idx+=1,n.match_idx=a.end,a;o=i.lastIndex-n.value.replace(/\\/g,"").length;if(o===0||e.charAt(o-1).search(m)===0)return a={},a.end=i.lastIndex,a.start=o,f.push(a),r.match_idx+=1,n.match_idx=a.end,a}r.complete=!0}return r.match_idx=-1,null}function N(e,t,n,r,i,s,o){var u,a=n||e.matchType!==2?T:x;while((u=a(t,n,r,i))!==null){if(!o){if(r.start_siIndex===s&&r.start_idx===u.start)continue;return!0}if(u.start>=r.start_idx)return r.start_idx=u.start,!0}return!1}function C(e,t){var n=t.matches,r,i,s,o,u,a,f;if(e.match_idx!==-1)r=e.match_idx,i=e.matches;else{if(e.fuzzy_match_idx===-1)return!1;r=e.fuzzy_match_idx,i=e.fuzzy_matches}u=i[r].start,a=i[r].end;for(s=0,o=n.length;s<o;s++){f=n[s];if(!(f.end<=u||a<=f.start))return!1}for(s=0,o=t.length;s<o;s++)if((t[s].match_idx!==-1||t[s].fuzzy_match_idx!==-1)&&t[s].group_id!==e.group_id)return!1;return f={},f.start=u,f.end=a,t.matches.push(f),!0}function k(e,t,n,r,i,s,o){if(i.phoneno&&!t.numeric)return!1;var u,a,f,l,c,h,p;for(u=0,a=i.length;u<a;u++)if(i[u].index===n){f=i[u];break}f||(f={},f.index=n,f.group_id=t.group_id,f.match_idx=-1,f.matches=[],f.fuzzy_match_idx=-1,f.fuzzy_matches=[],i.push(f));var d=f.match_idx;while(N(e,r,i.phoneno,t,f,s,o))if(C(f,i))return!0;if(d!==-1){p=i.matches,l=f.matches[d].start,c=f.matches[d].end;for(u=0,a=p.length;u<a;u++)h=p[u],h.start===l&&h.end===c&&p.splice(u,1)}return t.match_idx=-1,!1}function L(e,t,n,r){var i,s,o,u,a,f,l,c;s=p.length,c=!1,n.match_siIndex===-1&&(c=!0,n.start_siIndex=-1,n.start_idx=-1,r>0&&(l=e.filterItems[r-1],l.group_id===n.group_id&&(n.start_siIndex=l.match_siIndex,n.start_idx=l.match_idx)));if(c&&n.start_siIndex!==-1){i=n.start_siIndex,f=i<3;if(!f||!!n.numeric){o=p[i],u=t[o];if(u&&u.length>0){a=t._matches[o],a||(a=[],a.matches=[],f&&(a.phoneno=!0),t._matches[o]=a);if(k(e,n,r,u,a,i,!0))return n.match_siIndex=i,n.special_match=!0,!0}}}n.match_siIndex===-1?i=0:n.special_match?(n.special_match=!1,i=0):i=n.match_siIndex;while(i<s){f=i<3;if(f&&!n.numeric){i+=1;continue}o=p[i],u=t[o];if(u&&u.length>0){a=t._matches[o],a||(a=[],a.matches=[],f&&(a.phoneno=!0),t._matches[o]=a);if(k(e,n,r,u,a,i,!1))return n.match_siIndex=i,!0}i+=1}return n.match_siIndex=-1,!1}function O(e){var t,n;for(t=0,n=e.filterItems.length;t<n;t++)if(e.filterItems[t].match_siIndex!==-1)return!1;return!0}function M(e){var t,n,r,i,s,o,u,a;if(!e._matches)return!0;for(t=0,i=p.length;t<i;t++){s=p[t],o=e[s];if(o&&o.length>0){u=e._matches[s];if(u){if(u.matches.length>0)return!1;for(n=0,r=u.length;n<r;n++){a=u[n];if(a.match_idx!==-1)return!1;if(a.fuzzy_match_idx!==-1)return!1}}}}return!0}var t=e.common.Utils,n=t.escapeHtml,r=t.unescapeHtml,i=e.contacts,s=i.api,o=i.utils,u={},a=function(e){return e.emailField&&e.emailField.value?e.emailField.value:e.id},f=function(e,t){for(var n=0;n<t.length;n++)e.push(t[n]);return e},l=function(){var e=o.getSortedFlatContacts(),t=function(e,t){var n=[];return e.user&&n.push(e.user.charAt(t).toLowerCase()),e.firstname&&n.push(e.firstname.charAt(t).toLowerCase()),e.lastname&&n.push(e.lastname.charAt(t).toLowerCase()),e.nickname&&n.push(e.nickname.charAt(t).toLowerCase()),e.mobileno&&f(n,e.mobileno.toLowerCase()),e.homeno&&f(n,e.homeno.toLowerCase()),e.workno&&f(n,e.workno.toLowerCase()),e.isCategory||e.email&&n.push(e.email.charAt(t).toLowerCase()),n},n=function(e){var t=o.getHigherPrecedenceFieldByType(e,"name");return t?{firstname:t.givenName,lastname:t.familyName,middlename:t.middleName}:{}},r,i,s,l=o.getCategories();for(i in l){var c=l[i],h=0,p=[],d;for(r in c.contacts){var v=o.getContactById(c.contacts[r]),m=o.getFieldsByType(v,"email");m&&m.length&&(h+=1,d=n(v),d.email=m[0].value,p.push(d))}e.push({firstname:c.name,email:[h,"<span style='display:none'>___AC_CAT_ID:",c.id,"</span>"].join(""),id:c.id,count:h,endpoints:p,isCategory:!0})}s={},u=[];for(r in e){var g=e[r];if(!g.email||!g.email.length)continue;var y,b=t(g,0);for(y in b){var w=b[y];u[w]||(u[w]={}),u[w][a(g)]=g}}},c=function(e,t){var n={},r={},i={},s=null,f,l;f=e.filterItems;for(var c=0;c<f.length;c++){var h=f[c],p=h.value.charAt(0).toLowerCase
(),d=u[p];for(l in d){s=d[l];if(!d[l].isCategory||!t)r[l]=d[l]}}for(l in r){var v=r[l];e.filterContact(v)&&!i[v.email]&&(i[v.email]=!0,n[a(v)]=v)}var m=[];for(l in n)m.push(n[l]);return o.sortFlatContacts(m),m};e.on("contacts:api:contactChanged",l),e.on("contacts:api:loaded",l),o.areContactsLoaded()?l():s.load();var p=["mobileno","homeno","workno","firstname","lastname","user","email","nickname"],d=new RegExp("[\\+\\*\\?\\^\\[\\]\\{\\}\\$\\\\/%#~:<>()]","g"),v=new RegExp("[^0-9]","g"),m=new RegExp("[ _\\.\\-@]","g"),g=new RegExp("[ _\\.\\-@][^ _\\.\\-@]","g");h.prototype.fastMatch=function(e){return e=!!e,c(this,e).slice(0,this.match_limit)};var y=/___AC_CAT_ID\:(-?[0-9]+)/;h.prototype.decodeCategory=function(e){var t=y.exec(e);if(t&&t.length>1){var n=o.getCategoryById(t[1]),r=[];for(var i in n.contacts){var s=o.getBasicFlatContacts(o.getContactById(n.contacts[i]));for(var u in s){var f=s[u];if(f.isPrimary){r[a(f)]=f;break}}}return r}return!1},h.prototype.updateFilterItems=function(t){t.length>2048&&(t=t.substring(0,2048)),t=t.replace(d," ");var n=S(t),r,i=e.common.Utils;for(r in n)n.hasOwnProperty(r)&&(n[r]=i.regexpEscape(i.escapeHtml(n[r])));this.filterItems=E(n)},h.fuzzyMatch=function(e,t,n,r){var i=e.length,s=t.length,o=[],u=[],a=[],f,l,c,h,p,d,v,m,g,y,b,w;for(f=0;f<=i;f++)u[f]=f;h=s-n,h>i+r&&(h=i+r),c=0,d="";for(l=0;l<h;l++){m=d,d=t.charAt(l+n).toLowerCase(),c<=0?(g=l+1,a[0]=g,b=g,c=0,p=""):(g=r+1,a[c]=g,b=g,p=e.charAt(f-1).toLowerCase());for(f=c,c=-1;f<i;f++){v=p,p=e.charAt(f).toLowerCase(),p===d?g=u[f]:(g=u[f]+1,y=a[f]+1,g>y&&(g=y),y=u[f+1]+1,g>y&&(g=y),p===m&&v===d&&(y=o[f-1]+1,g>y&&(g=y))),a[f+1]=g,b>g&&(b=g),c===-1&&g<=r&&(f===0&&a[0]<=r?c=0:c=f+1);if(g>a[f]&&g>r)break}if(f===i){if(g===0){u=a,l+=1;break}y=u[i];if(y!==undefined&&y<g)break}if(b>r)return null;o=u,u=a,a=[]}return g=u[i],g===undefined||g>r?null:(w={},w.start=n,w.end=l+n,w.diff=g,w)},h.prototype.filterContact=function(e){delete e.matches;if(this.filterItems.length===0)return!1;this.init_temp_data&&(e._matches={});var t,n;n=this.filterItems.length,t=0;while(t<n){if(!L(this,e,this.filterItems[t],t)){if(t>0){t-=1;continue}return this.del_temp_data&&delete e._matches,!1}t+=1}e.matches={};var r,i,s,o,u,a,f,l,c;i=p.length,r=0;while(r<i){s=p[r],o=e._matches[s];if(o&&o.length>0){for(t=0,n=o.length;t<n;t++)u=o[t],(f=u.match_idx)!==-1?(a=this.filterItems[u.index],c=u.matches[f],l={},l.term=a.value,l.startIndex=c.start,l.endIndex=c.end,e.matches[s]||(e.matches[s]=[]),e.matches[s].push(l),u.match_idx=-1):(f=u.fuzzy_match_idx)!==-1&&(a=this.filterItems[u.index],c=u.fuzzy_matches[f],l={},l.term=a.value,l.startIndex=c.start,l.endIndex=c.end,l.diff=c.diff,e.matches[s]||(e.matches[s]=[]),e.matches[s].push(l),u.fuzzy_match_idx=-1);this.del_temp_data||(o.matches=[])}r+=1}this.del_temp_data&&delete e._matches;for(t=0,n=this.filterItems.length;t<n;t++)this.filterItems[t].match_siIndex=-1;return!0},h.prototype.setConfigValues=function(t,n,r){this.matchType=t,this.init_temp_data=e.Lang.isBoolean(n)?n:!0,this.del_temp_data=e.Lang.isBoolean(r)?r:!0},h.prototype.filterContacts=function(e){var t=!0,n=[];if(this.filterItems.length!==0){this.setConfigValues(1,!0,!t);for(var r in e)typeof e[r].email!="undefined"&&this.filterContact(e[r])&&n.push(e[r])}return n},h.prototype.buildContactsIndex=function(){l()};var A=function(){function s(t){var n=u(t),s;return t.isCategory?s=e.common.Utils.substitute(r,{hilite:n},0,0,0,0,strings):s=e.common.Utils.substitute(i,{hilite:n,id:t.id,email:t.email,emailFieldId:t.emailField.id},0,0,0,0,strings),s}function o(t,n,r,i){var s="";return t||n||r?(s=e.common.Utils.substitute(strings.str_name_format,{given_name:t?t:"",middle_name:n?n:"",family_name:r?r:""}),s=s.replace(/ +(?= )/g,"")):i?s=i:s="",s}function u(t){function x(e,t,n){var r="";switch(t){case"amp":n?r="&"+n+";":r="&";break;case"#39":r="'";break;case"quot":r='"';break;case"lt":r="<";break;case"gt":r=">";break;case"#35":r="#";break;default:r=""}return r}var n=t.matches,r,i,s,u="",f="",l="";if(n&&(n.nickname||n.user||n.firstname||n.lastname||n.mobileno||n.homeno||n.workno||n.email)){var c=e.Lang.isArray(n.nickname)&&n.nickname.length>0?!0:!1,h=e.Lang.isArray(n.firstname)&&n.firstname.length>0?!0:!1,p=e.Lang.isArray(n.lastname)&&n.lastname.length>0?!0:!1,d=e.Lang.isArray(n.email)&&n.email.length>0?!0:!1,v=t.nickname||null,m=t.firstname||null,g=t.lastname||null,y=t.email||null,b=c?a(v,n.nickname):v&&v.length>0?v:null,w=h?a(m,n.firstname):m&&m.length>0?m:null,E=p?a(g,n.lastname):g&&g.length>0?g:null,S=d?a(y,n.email):null;r="",r=o(w,"",E,b),b=c?b:null,w=h?w:null,E=p?E:null,i="",S?i+=S:i+=y,f=r||"",f=e.Lang.trim(f),f!==""&&(NeoConfig.bidi?(s=e.Intl.detectDirection(u.replace(/<\/?b\>/,"")),f="<span data-name dir="+s+">"+f+"</span>"):f="<span data-name>"+f+"</span>"),i.length>0&&(f.length>0&&(f+=" "),f===""?l="<em class='email no-name'"+(t.isCategory?"":" data-email='"+y+"'")+" dir='ltr'>"+i+"</em>":l="<em class='email'"+(t.isCategory?"":" data-email='"+y+"'")+" dir='ltr'>("+i+")</em>")}return l=l.replace(/&((?:[a-zA-Z]+)|(?:#[0-9]+));(?:([a-zA-Z]+|(?:#[0-9]+));)?|([;,])/gi,x),u=f+l,u}function a(t,n){var r=t,i,s,o,u,a;n.sort(l),s=r.length;for(i=n.length-1;i>=0;i--)o=n[i],NeoConfig.bidi?(u=r.substring(0,o.startIndex),a=r.substring(o.endIndex,s)+r.substring(s),r=u+e.comms.Intl.highlightString(r.substring(o.startIndex,o.endIndex),u,a)+a):r=r.substring(0,o.startIndex)+f(r.substring(o.startIndex,o.endIndex))+r.substring(o.endIndex,s)+r.substring(s),s=o.startIndex;return r=r.substring(0,s)+r.substring(s),r}function f(e){return"<b>"+e+"</b>"}function l(e,t){return typeof e=="object"&&typeof t=="object"&&typeof e.startIndex=="number"&&typeof t.startIndex=="number"?+(e.startIndex-t.startIndex):0}var t='<li role="option"><span class="ac-value">{{hilite}}</span><span data-action="ac-remove-item" data-ac-email-field-id="{{emailFieldId}}" data-ac-id="{{id}}" data-ac-email="{{email}}" class="icon icon-small-close ac-remove-item"></span></li>',n='<li role="option"><span class="ac-value">{{hilite}}</span></li>'
,r=n,i=NeoConfig.enableContactDelete?t:n;return{getItemMarkup:s,hlMatch:a,buildName:o}}();h._test={validateFilterItems:O,validateTempMatchData:M},e.namespace("comms").FilterContacts=h,e.namespace("comms").FilterContactsMarkup=A},"1.0.0",{requires:["contacts-api-utils","contacts-api","common-utils"]});
YUI.add("comms-intl-bidihighlight",function(A){A.mix(A.namespace("comms.Intl"),{_needPrevChar:/[\u0620\u0622-\u063F\u0641-\u064A\u066E\u066F\u0671-\u0673\u0675-\u06D3\u06D5\u06EE\u06EF\u06FA-\u06FC\u06FF\u0710\u0712-\u072F\u074D-\u077F\u07CA-\u07EA]/,_needNextChar:/[\u0620\u0626\u0628\u062A-\u062E\u0633-\u063F\u0641-\u0647\u0649\u064A\u066E\u066F\u0678-\u0687\u069A-\u06BF\u06C1\u06C2\u06CC\u06CE\u06D0\u06D1\u06FA-\u06FC\u06FF\u0712-\u0714\u071A-\u071D\u071F-\u0727\u0729\u072B\u072D\u072E\u074E-\u0758\u075C-\u076A\u076D-\u0770\u0772\u0775-\u0777\u077A-\u077F\u07CA-\u07EA]/,_highlightJoiner:"\u200d",_highlightStartTag:"<b>",_highlightEndTag:"</b>",_initializeBidiHighlightJoiner:function(){},highlightString:function(I,J,G){var K,F,M,D,B,L,C,E,H;E=function(N){return N===""?"":N.charAt(N.length-1);};H=function(N){return N===""?"":N.charAt(0);};if(I.length===0){return"";}L=E(J);C=H(G);K=I.charAt(0);M=I.charAt(I.length-1);F=K.charCodeAt(0);D=M.charCodeAt(0);if(L===""||L.charCodeAt(0)<1568||F<1568){B=this._highlightStartTag+I;}else{if(this._needNextChar.test(L)&&this._needPrevChar.test(K)){B=this._highlightJoiner+this._highlightStartTag+this._highlightJoiner+I;}else{B=this._highlightStartTag+I;}}if(C===""||C.charCodeAt(0)<1568||D<1568){B=B+this._highlightEndTag;}else{if(this._needPrevChar.test(C)&&this._needNextChar.test(M)){B=B+this._highlightJoiner+this._highlightEndTag+this._highlightJoiner;}else{B=B+this._highlightEndTag;}}return B;}});A.comms.Intl._initializeBidiHighlightJoiner();},"1.0.0");YUI.add("ac-widget",function(e){function s(e){var t=null,n=null;return e&&(n=e.one(".ac-value"))&&(t=n.get("text")),t}function o(e){var t=this;e.ac=t._getEventPlugin(e),e.itemNodeToValue?this._nodeToValue=e.itemNodeToValue:this._nodeToValue=s,e.ac&&o.superclass.constructor.apply(t,[e])}var t=e.Lang,n=e.contacts,r=n.utils,i=e.comms;o.NAME="ACWidget",e.extend(o,i.ui.AutoComplete,{bind:function(){o.superclass.bind.apply(this,arguments)},bindUI:function(){o.superclass.bindUI.apply(this,arguments)},_getEventPlugin:function(e){var n=!1,r=t.isUndefined;return!r(e.acNode)&&!r(e.acTarget)&&(n=e.acTarget.plug(i.ui.AutoCompleteEventsPlugin,{alignNode:e.acNode}).ac),n},refresh:function(e){var t=this,n=!1;return n=t._getEventPlugin(e),n?(e.ac=n,t.setAttrs(e)):t},getItemMarkup:function(t){return e.comms.FilterContactsMarkup.getItemMarkup(t)},click:function(t){var n=this,r=n.get("ac");t.halt();if(t.target.hasClass("ac-remove-item")){var s=t.target,o=s.getAttribute("data-ac-id"),u=s.getAttribute("data-ac-email-field-id"),a=s.getAttribute("data-ac-email");e.fire("mt:click",{action:"ac_del",append:{ltxt:n._selectedIndex}}),e.use("common-ui-dialog-helper","_shared_module_offscreen_bin_modal_btn_generic",function(e){var t=e.common.Utils.substitute(e.ui.Templates._shared_module_offscreen_bin_modal_btn_generic.base,0,0,0,{btnID:"ok",btnLabel:strings.str_delete}),n=e.common.Utils.substitute(e.ui.Templates._shared_module_offscreen_bin_modal_btn_generic.base,0,0,0,{btnID:"cancel","default":"default",btnLabel:strings.str_btn_cancel}),s={hd:strings.str_address_remove_hd,bd:e.common.Utils.substitute(strings.str_contacts_remove_bd,{name:a}),ft:t+n},f={ok:{handler:function(){var t=new i.FilterContacts;e.contacts.api.removeEmail(o,parseInt(u,10),t.buildContactsIndex),r.set("queryValue",""),s={hd:strings.str_address_removed_hd,bd:e.common.Utils.substitute(strings.str_address_removed_bd,{name:a}),ft:e.common.Utils.substitute(e.ui.Templates._shared_module_offscreen_bin_modal_btn_generic.base,0,0,0,{btnID:"ok","default":"default",btnLabel:strings.str_ok})},e.common.ui.DialogHelper.createCommon(s)}},cancel:{handler:function(){r.set("queryValue","")}}},l=function(){};e.common.ui.DialogHelper.createCommon(s,f,l)})}else{var f;e.fire("mt:click",{action:"ac_select",append:{ltxt:n._selectedIndex}}),f=t.currentTarget.getData("selectedCb");if(f){f.call(t.target,t);return}n._selectedIndex=-1;var l=this._nodeToValue(t.currentTarget);l!==null&&(r.set("queryValue",l),r.get("host").simulate("keydown",{keyCode:13})),n._currentValue=l,r.get("host").focus()}n.hide()},handleEnter:function(e,t){var n=t.get("ac"),s=t._selectedIndex,o,u;e.halt();var a=new i.FilterContacts;if(t.get("data").queryStr!==n.get("queryValue")){a.updateFilterItems(n.get("queryValue"));var f=a.filterContacts(r.getSortedFlatContacts(["firstname","lastname","email"]));t.setAttrs({query:n.get("queryValue"),data:f}).drawMarkUp().setAlign().show()}s!==-1&&(o=t.item(s),o&&(u=this._nodeToValue(o),u!==null&&(n.set("queryValue",u),t._selectedIndex=-1,n.get("host").focus(),t.hide())))},triggerQuery:function(){this.get("ac").fire("ac:query",{value:this.get("ac").get("queryValue")})},isMousedOver:function(){var e=this.get("boundingBox"),t=e&&(e.one("div.ac-results:hover")||e.one("div.ac-results li.over")||e.one("li.yui3-aclist-item-hover"));return!!t},buildName:e.comms.FilterContactsMarkup.buildName}),o.ATTRS={host:{value:null,getter:function(){return this.get("ac").get("host")}},alignNode:{value:null,getter:function(){return this.get("ac").get("alignNode")}}},e.namespace("contacts.ui"),e.contacts.ui.ACWidget=o},"1.0.0",{requires:["overlay","node-event-simulate","comms-ui-autocomplete-plugin","comms-ui-autocomplete","contacts-api-utils","contacts-api","filter-contacts","common-utils","comms-intl-bidihighlight"]});
