YUI.add("mail-ui-imap-in",function(e){var t,n=e.mail,r=e.common.Utils,i=r.features,s=r.settings,o=n.Controller.ImapIn,u=e.mail.model.DataStore.Accounts,a=r.escapeHtml,f=n.FoldersView,l=r.ezSub,c="invisible",h="#accountListnav",p="single-account",d="multiple-account",v=e.one(h),m=e.one("#imapNavWrapper"),g=e.one("body"),y=NeoConfig.accounts.imapInAccounts&&NeoConfig.accounts.imapInAccounts.length+1||1,b=e.one("#storm-listnav"),w=n.ui.FolderUtils,E=[];t=function(){function t(e,t,n){var r=e.id,i="unsynced",s=w.getInboxFid(r),o;switch(n){case"start":s||(E.push(r),t.addClass(i),t.one(".status-icon").set("title",l(NeoConfig.strings.str_nav_left_pending_title,{account_name:e.email})));break;case"done":o=E.indexOf(r),o>-1&&E.splice(o,1),t.removeClass(i),t.one(".status-icon").set("title",strings.str_nav_left_syncing_title);break;default:}}function n(t,r,i,s){var o=NeoConfig.imapSyncTime*6e4,u=s?"syncing":"pending";switch(i){case"start":r.addClass(u),s?setTimeout(e.bind(n,null,r,"done"),o):r.one(".account-status").set("title",l(NeoConfig.strings.str_nav_left_pending_title,{account_name:t.email}));break;case"done":r.removeClass(u);break;default:}}function h(r,i){var s=r.id,o=e.one('[data-fid="'+s+'"]');n(r,o,"start",i),i&&t(r,o,"start")}function S(t){var n=t.status==="ENABLED",r,i;y++,y===2&&g.replaceClass(p,d),t=t||{},r=t.description||t.email,i=t.email,e.use("minty_module_shell_navigation_pane_account_item",function(){var s=e.ui.Templates.minty_module_shell_navigation_pane_account_item;v.append(e.Node.create(l(s.base,{account_icon:"icon-mail-inbox",account_title:i,account_text:a(r),account_id:t.id,isSelected:t.isPrimary?!0:!1,isPrimary:t.isPrimary?!0:!1,account_action:"load-account"},s))),h(t,n)})}function x(t){var n='[data-fid="'+t.id+'"]',r=e.one(n),i=NeoConfig.strings,s,o;r&&(s=t.description,s||(t.isPrimary?s=i.str_branding:s=t.email),o=r.one(".foldername"),o&&o.setHTML(a(s)))}function T(t){t.preventDefault(),e.fire("openOptions",{view:"accounts"})}function N(e){var t,n,r,i;if(typeof e!="string")return NeoConfig.isCorpmail?"google":"";n=e.match(/.+?@([^.]+?)\..+/i);if(!n)return NeoConfig.isCorpmail?"google":"";t=n[1],i=s.value("imapProviderDomain");for(r in i){if(!i.hasOwnProperty(r))continue;if(i[r].domainCheck&&i[r].domainCheck.indexOf(t)>=0)return r}return NeoConfig.isCorpmail?"google":""}function C(t){var n=this,r=(u.getAll()||[]).filter(function(e){return e.id===t})[0],i=r&&n.getProvider(r.email)||"",s=strings.str_nav_left_reauth_alert_notification,o=!1,a=800,f=600,c=screen.width/2-a/2,h=screen.height/2-f/2;i==="google"&&(s=l(strings.str_nav_left_reauth_alert_notification_google,{str_branding_google:strings.str_branding_google}),o=!0,f=700),e.common.ui.NotificationV2.notify(s,{type:"error",cbk:function(n,r){r==="options"&&(o&&(window.oAuthWindow=window.open("","authorizeWindow","width="+a+", height="+f+", top="+h+", left="+c)),e.fire("openOptions",{view:"accounts",subView:{sid:"edit",accId:t,autoReauth:o}}),e.fire("util:ymstats",{name:"reauth_notification_click",include:{farm:!0}}))},close:!0,speed:"fast"})}function k(t){var n=t.target,r=t.currentTarget,i=!r.hasClass("selected"),s=o.getCurrentAccountId(),a=r.getAttribute("data-fid"),f=!1,l,c,h,p,d,m=800,g=600,y=screen.width/2-m/2,w=screen.height/2-g/2;if(r.hasClass("pending")||r.hasClass("unsynced")||n&&n.hasClass("renamer"))return;if(n&&n.getAttribute("data-action")==="reauth"){t.halt(),l=(u.getAll()||[]).filter(function(e){return e.id===a})[0],c=l&&this.getProvider(l.email)||"",f=!1,c==="google"&&(f=!0,g=700),f&&(window.oAuthWindow=window.open("","authorizeWindow","width="+m+", height="+g+", top="+w+", left="+y)),e.fire("openOptions",{view:"accounts",subView:{sid:"edit",accId:a,autoReauth:f}}),e.fire("util:ymstats",{name:"reauth_leftrail_click",include:{farm:!0}});return}e.fire("accounts:select",{acctId:a,isPrimary:r.hasClass("primary"),switchAccount:i,prevAcctId:s}),e.fire("mt:click",{action:"account_switch_"+(a==="1"?"primary":"external")}),i?(o.setCurrentAccount(a),h=v.all(".account-item-li"),h.removeClass("selected"),r.addClass("selected")):(p=b.one(".in"),d=p.hasClass("selected"),d||(h=b.all(".sysfolder, .folder"),h.removeClass("selected"),p.addClass("selected")))}function L(e){var t=e.id,n='[data-fid="'+t+'"]',r=m.one(n),i=o.getCurrentAccountId(),s=m.one(".account-item-li.primary");t!==Neo.getSelectedAccountId()&&r&&y>1&&(y--,r.remove(),t===i&&k({currentTarget:s}),y===1&&g.replaceClass(d,p))}function A(t){e.use("mail-ui-folderevents",function(e){t.isAccount=!0,e.mail.ui.FolderEvents.handle(t)})}function O(t){var n=v.menu.getContextTarget(),r,i;if(n){t.target=n.ancestor(".account-item-li",!0),i=t.dataAction,r=t.target.getAttribute("data-fid");switch(i){case"account-new":e.fire("openOptions",{view:"accounts",subView:{sid:"providerList"}});break;case"account-rename":A(t);break;case"account-edit":e.fire("openOptions",{view:"accounts",subView:{sid:"edit",accId:r}})}e.fire("mt:click",{action:"cntxt_mnu_imap_acct_itm_"+i})}}function M(){var t=v.menu,n=t.getContextTarget().ancestor(".account-item-li"),r=e.one("#menu-account");r.setAttribute("data-context",n.hasClass("pending")||n.hasClass("unsynced")?"rclick-disabled":"")}function _(t){t.preventDefault(),e.use("common-ui-menu-helper","minty_module_shell_navigation_pane_account_menu",function(e){if(!v.menu){var n=e.common.ui.MenuHelper,r=e.ui.Templates.minty_module_shell_navigation_pane_account_menu,i=e.Node.create(l(r.base,{},r));g.append(i),n.create(v,{menu:i,isContext:!0,xy:[t.clientX,t.clientY],contextTarget:t.target,setVisibleCbk:M},function(){i.on("menuSelected",O)})}})}function D(t){var n=t.target,r=n.getAttribute("data-action");switch(r){case"manage-accounts":T(t);break;case"folder-search":e.use("mail-ui-folderevents",function(e){e.mail.ui.FolderEvents.handle({dataAction:"folder-search",target:t.currentTarget})});break;case"add-new-folder":e.fire("newfolder:pressed",n.getAttribute("id"));break;default:}}function P(t){var n,i,s,o,u;for(u in t)i=t[u],o=v.one('.account-item-li[data-fid="'+
u+'"]'),o&&(s=o.one(".unread-count"),i.acctUnreadCount>0?(s.setHTML("("+r.getNormalizedMessageCount(i.acctUnreadCount)+")"),s.removeClass(c)):(s.addClass(c),s.setHTML("")),s.set("title",l(strings.str_nav_folder_unread_cnt,{unread_cnt:i.acctUnreadCount+""})));n=e.mail.model.DataStore.Accounts.getCurrentAccount(),n=n&&n.id||Neo.getSelectedAccountId(),e.mail.FoldersView.updateFolderUnreadCountMarkup(t[n])}function H(){var t=m.one(".list-separator"),n="collapsed";m.hasClass(n)?(t.setAttribute("title",strings.str_nav_left_accounts_expanded),e.fire("mt:click",{action:"toggle_account_list_expand"})):(t.setAttribute("title",strings.str_nav_left_accounts_colapsed),e.fire("mt:click",{action:"toggle_account_list_collapse"})),m.toggleClass(n)}function B(e){return v.one('[data-fid="'+e+'"]')}function j(){var n=window.Mousetrap,r=this;e.on("ds:account:add",S),e.on("ds:account:remove",L),e.on("ds:account:update",x),e.on("ds:folder:change",function(){var e=E.length,n,r,i,s;for(s=0;s<e;s++)n=E[s],w.getInboxFid(n)&&(r=v.one('[data-fid="'+n+'"]'),i={id:n},t(i,r,"done"))}),m.delegate("click",D,"a .btn-action"),v.delegate("click",e.bind(k,r),"li"),v.delegate("contextmenu",_,"li"),v.delegate("dblclick",function(e){e.halt();if(e.currentTarget.hasClass("pending")||e.currentTarget.hasClass("unsynced"))return;f.handleFolderActions({dataAction:"account-rename",target:e.currentTarget,actionSource:"activeFolder",isAccount:!0})},"li"),m.one(".list-separator").on("click",H),n.bind(["command+shift+a","ctrl+shift+a"],T,"keydown"),e.once("ws:postLoad",function(){if(NeoConfig.isEmailOrPhoneReg){var t=o.getSelectedAccountId(),n;o.setCurrentAccount(t),n=B(t),n&&n.addClass("selected"),e.fire("accounts:select",{acctId:t,isPrimary:!1,switchAccount:!0,prevAcctId:Neo.getSelectedAccountId()})}}),e.on("accounts:select",function(e){var t=B(e.acctId);if(!t)return;i.enabled("reAuthAlerts")&&t.hasClass("reauth-alert")&&r.showReAuthNotification(e.acctId)}),e.on("accounts:alert",function(e){i.enabled("reAuthAlerts")&&r.showReAuthNotification(e.acctId)})}function F(){this.bindUI()}e.mix(this,{updateAccountsUnreadCount:P,addAccountItemMarkup:S,updateAccountItemMarkup:x,removeAccountItemMarkup:L,addSyncingMarkup:h,switchSyncingIcon:n,toggleAccounts:H,manageAccount:T,selectAccount:k,renameAccount:A,showReAuthNotification:C,accountMenuSelected:O,accountContextMenu:_,handleImapNav:D,bindUI:j,init:F,getProvider:N})};var S=new t;S.init(),e.namespace("mail.ui").ImapIn=S},"1.0.0",{requires:["common-utils","mail-controller-imapin","mail-ui-foldersview-base","mail-model-datastore","mail-ui-folder-utils","mail-common-utils-features","mail-common-utils-settings","common-ui-notification-v2"]});
