YUI.add('subcompose_strings', function(Y) {
Y.namespace("mail");
Y.mix(strings,[]);
}, '1.0.0');YUI.add("comms-utils",function(e){e.namespace("comms");var t={},n=e.Lang,r=n.trim,i=/{{([^{}]*)}}/g;e.mix(t,{substitute:function(e,n,r,s,o,u,a){if(typeof e!="string")return;return a&&(e=a.str||e,n=a.obj||n,r=a.formatters||r,s=a.args||s,o=a.strings||o,u=a.templates||u),e.replace(i,function(e,f){var l,c,h=t.substitute;return r&&(l=a&&a.formatters?a.formatters[f]:r[f])?l(n,s,a)||"":n&&f in n?(c=n[f],typeof c=="string"&&c.match(i)?h(c,n,r,s,o,u,a):c):o&&f in o?(c=o[f],c.match(i)?h(c,n,r,s,o,u,a):c):u&&f in u?h(u[f].base||u[f],n,r,s,o,u,a):""})},escapeHtml:function(e){return e===null?null:(e=""+e,e=e.replace(/&(?!(amp|lt|gt|quot|#39|#92);)/g,"&amp;"),e=e.replace(/</g,"&lt;"),e=e.replace(/>/g,"&gt;"),e=e.replace(/\"/g,"&quot;"),e=e.replace(/\'/g,"&#39;"),e=e.replace(/\\/g,"&#92;"),e)},unescapeHtml:function(e){return e===null?null:(e=""+e,e=e.replace(/&amp;/g,"&"),e=e.replace(/&lt;/g,"<"),e=e.replace(/&gt;/g,">"),e=e.replace(/&quot;/g,'"'),e=e.replace(/&#39;/g,"'"),e=e.replace(/&#92;/g,"\\"),e)},createAddress:function(e){var n=!1,i=null,s=null,o=/(<[^<>]+@[^<>]+\.[^<>]+>)|(\([^\(\)]+@[^\(\)]+\.[^\(\)]+\))|(\[[^\[\]]+@[^\[\]]+\.[^\[\]]+\])/,u,a=e.replace(/\".*\"/g,"");return!r(a)||a.indexOf("@")<0?{fail:!0,email:e,name:t.escapeHtml(e)}:(o.test(e)?(u=e.match(o),s=u[0],i=r(e.replace(s,"")),s=s.substring(1,s.length-1)):s=i=r(e),t.isValidEmail(s)||(n=!0),{fail:n,email:s,name:t.escapeHtml(i)})},isValidEmail:function(e){if(!e)return!1;var t=0,n=e,r=e.lastIndexOf("@"),i=e.substr(0,r),s=i.replace(/\\\\/g,""),o=e.substr(r+1),u=o.length,a=/^(\\.|[A-Za-z0-9!#%&`_=\/$'*+?^{}|~.-])+$/,f=/^"(\\"|[^"])+"$/,l=/^[A-Za-z0-9\-]+$/;!a.test(s)&&!f.test(s)&&(n=!1),o=o.split("."),u=o.length,u<2&&(n=!1);while(t<u)l.test(o[t++])||(n=!1);return n},splitName:function(e){var t={},n,i,s=r(e),o,u,a=[],f=strings.str_name_format.replace(/\{|\}/g,"").split(" "),l=!1,c=!0;f[0]==="family_name"&&(l=!0),f.length<3&&(c=!1);while(s){o=s.match(/([^\u3000\s]*)[\u3000\s]+/);if(!o||o.length!==2||!o[0]){a.push(s);break}a.push(o[1]),s=s.substring(o[0].length)}n=a.length;for(i=0;i<n;i+=1){u=a[i];switch(i){case 0:t[l?"familyName":"givenName"]=u;break;case 1:c&&2<n?t.middleName=u:t[l?"givenName":"familyName"]=u;break;case 2:c?t[l?"givenName":"familyName"]=u:t[l?"givenName":"familyName"]+=" "+u;break;default:t[l?"givenName":"familyName"]+=" "+u}}return t}}),e.comms.Utils=t},"1.0.0",{requires:[]});
YUI.add("mail-ui-desktop-notifications-mail",function(e){function O(t){return!e.Lang.isArray(t)||t.length===0?!1:!0}function M(e){return typeof t.getVal(e,"from.name")=="undefined"||typeof t.getVal(e,"from.email")=="undefined"?!1:!0}function _(e){var t=!0,n,r;if(!O(e))return null;if(e[0].cid===undefined)return null;if(e.length===1)return!0;r=e[0].cid;for(n=1;n<e.length;n++){if(!e[n].cid)return null;if(e[n].cid!==r){t=!1;break}}return t}function D(e){var t=[],n={},r=0,i=0,o,u,a;if(!O(e))return null;o=e.length;for(u=0;u<o;u++){if(!M(e[u]))return null;a=e[u].from.name.trim()!==""?e[u].from.name:e[u].from.email;if(a.trim()==="")continue;if(s-(16+t.length*2+i+a.length+2)<0)continue;a in n?(n[a]++,r++):(n[a]=1,t.push(a),i+=a.length)}return P(e,t,r)}function P(e,n,r){var i,s,o;return n.length===0?"":n.length!==1||n.length!==e.length&&r+1!==e.length?n.length+r<e.length?(s=e.length-(n.length+r),s===1?(i=strings.str_notif_other,t.ezSub(i,{comma_separated_recipient_list:n.join(", ")})):(i=strings.str_notif_others,t.ezSub(i,{comma_separated_recipient_list:n.join(", "),num_others:String(s)}))):(i=strings.str_notif_recipients,o=n.pop(),t.ezSub(i,{comma_separated_recipient_list:n.join(", "),single_recipient:o})):(i=strings.str_notif_recipient,t.ezSub(i,{single_recipient:n[0]}))}function H(t){e.fire("openMessage",{fid:t[0].folderInfo.fid||n.getInboxFid(),isConv:0,msg:t[0]}),window.focus()}function B(){e.fire("openInbox"),window.focus()}function j(t){e.fire("openConv",{fid:t[0].fid||n.getInboxFid(),isConv:1,isThread:!0,msg:t[0]}),window.focus()}function F(t,n){e.fire("util:ymstats",{name:"notifications_click_invoke",tags:{agent:m}}),NeoConfig.hasConvView?t.length>1&&!_(n)?B():j(t):t.length>1?B():H(t)}function I(e){var n;return O(e)?e.length>1?(n=strings.str_notif_new_msg,t.ezSub(n,{num_new_msgs:String(e.length)})):M(e[0])?e[0].from.name.trim()!==""?e[0].from.name:e[0].from.email:null:null}function q(t){return O(t)?t.length>1?D(t):e.common.Utils.getVal(t[0],"subject")?t[0].subject:"":null}function R(e){var n,r,s;if(!e){var o=Date.now();t.fireUnifiedStat({name:"unseen_notification_count_zero",tags:{agent:m},include:{bucket:!0}},"all");return}s=e===1?strings.str_notif_unseen:strings.str_notifs_unseen,n=t.substitute(s,{unseen_count:e}),r=function(){var e=Date.now();t.fireUnifiedStat({name:"unseen_notification_clicked",tags:{agent:m,minutes_to_click:Math.ceil((e-parseInt(localStorage.getItem(k),10))/6e4)},include:{bucket:!0}},"all"),B()},i=h.notify(n,S,r,u,L),t.fireUnifiedStat({name:"unseen_notification_shown",tags:{agent:m},include:{bucket:!0}},"all"),et()}function U(){var n=o,r,s,a=u,f,l,c;l=function(e){var t=NeoConfig.hasConvView?e.msgs[0].from.email:e.from.email;return v.indexOf(t)>-1},c=function(e){var t=NeoConfig.hasConvView?e.msgs[0].classification:e.classification,n=t&&t.category;return n&&n.indexOf("P")>-1},b?n=n.filter(l):w&&(n=n.filter(c)),NeoConfig.hasConvView?r=n.reduce(function(e,t){return e.concat(t.msgs)},[]):r=n;if(!n||n.length===0)return;E=I(r),S=q(r);if(E===null||S===null)return;s=function(){o=[],F(n,r)},t.features.enabled("mosaicNotifications")?f=z(r):f=r.length===1?W(r[0].from.email):undefined,i=h.notify(E,S,s,a,f),e.fire("util:ymstats",{name:"notifications_notify_invoke",tags:{agent:m,length:r.length}})}function z(n){var r,i,s,o,u,a=[];r=n.map(function(e){return e.from.email}).filter(function(e,t,n){return n.indexOf(e)===t}),u=r.slice(0,4);for(var f=0;f<u.length;f++)e.comms.Utils.isValidEmail(u[f])&&a.push("smtp:"+encodeURIComponent(u[f]));return i=e.xobniContacts.Utils.getXobniBaseURL().url+"/v4/endpoints/mosaic?endpoints="+a.join(","),i+="&total="+r.length+"&badge=true&spsize=",o=t.settings.value("notificationToastImageRes"),typeof window.devicePixelRatio!="undefined"&&window.devicePixelRatio>=2&&(o*=2),i+=o+"x"+o,s=t.settings.value("yahooMailNotificationLogo")+o+"x"+o+"_2.png",i+="&fallback_url="+s,i+="&ymreqid="+e.common.net.Session.genReqID(),i}function W(n){var r,i,s;return r=e.xobniContacts.Utils.getXobniBaseURL().url+"/v4/endpoints/smtp:"+n+"/photo?format=image&badge=true&spsize=",s=t.settings.value("notificationToastImageRes"),typeof window.devicePixelRatio!="undefined"&&window.devicePixelRatio>=2&&(s*=2),r+=s+"x"+s,i=t.settings.value("yahooMailNotificationLogo")+s+"x"+s+"_2.png",r+="&fallback_url="+i,r}function X(t){this.watermark=t.getMostRecentTimestamp(),t.on("MailList:modelRefresh",this.onListRefresh,this),NeoConfig.multipleAccounts&&e.on("accounts:select",function(){x&&x.detach(),x=t.once("renderComplete",function(){this.watermark=t.getMostRecentTimestamp()},this)},this)}function V(t){var n;if(!K())e.use("mail-ui-onboarding-desktop-notification",function(){n=e.mail.ui.onboarding.mailDesktopNotificationOnboard,n.init(n.calloutType.AUTO_CHECK_MAIL),f=!1});else if(window.Notification.permission==="default"&&h.getSavedPreference()==="granted")h.getUserPermission(function(t){e.fire("util:ymstats",{name:"notifications_permission_"+t,tags:{agent:m}})});else{if(tt()){J();return}if(!O(t))return;l||(o.unshift.apply(o,t),e.mail.ui.mailDesktopNotifications.notify())}}function $(e){if(!e||typeof e.list=="undefined")return;var t=e.list.getNewMsgs(this.watermark),r=e.list.getMostRecentTimestamp();r&&n.isInboxFid(e.list.fid)&&(this.watermark=r),this.handleNotify(t)}function J(){var n=Date.now(),r=parseInt(localStorage.getItem(C),10)||parseInt(localStorage.getItem(k),10),i=n-r;i>=N&&e.mail.controller.v3.api.getUnseenCount({successCallback:function(e){R(e.unseenCount)},failureCallback:function(e){e.httpCode===0?t.fireUnifiedStat({name:"unseen_notification_count_offline",tags:{agent:m,error:JSON.stringify(e)},include:{bucket:!0}},"yamas"):t.fireUnifiedStat({name:"unseen_notification_count_failed",tags:{agent:m,error:JSON.stringify(e)},include:{bucket:!0}},"yamas")}})}function K(){return!f||h.getSavedPreference()==="granted"}function Q(){return new Promise(function(e){yui.xobniContacts.searchAPI.getImportantContacts({},function(t){var n=[],r=[],i,s,o;for(s=0;s<t.length;s++)for(o=0;o<t[s].endpoints
.length;o++)t[s].endpoints[o].ep.indexOf("smtp:")!==-1?(i=t[s].endpoints[o].ep.replace(/smtp:/i,""),n=n.concat(i)):n=n.concact(t[s].endpoints[o].ep);n.length?(n.forEach(function(e){r.push("fromaddress:"+e)}),e(("("+r.join(" ")+")").replace(/\+/g,""))):e("")},function(){e("")})})}function G(e){v=e.split(" ").map(function(e){return e.slice(e.indexOf(":")+1)})}function Y(){var e;y?Q().then(function(e){G(e)}):(e=r.get("importantQuery"),e?G(e):Q().then(function(e){G(e)}))}function Z(){localStorage.setItem(k,Date.now()),this.blurInterval=setInterval(function(){e.fire("showUnseenCount")},T)}function et(){localStorage.setItem(C,Date.now())}function tt(){var e=Date.now(),n=parseInt(localStorage.getItem(k),10)||e,r=e-n;return t.features.enabled("unseenCountNotification")&&r>=T&&!l}function nt(){var n=-1;c.on("blur",function(){e.detach("showUnseenCount"),l=!1,t.features.enabled("unseenCountNotification")&&(Z(),e.on("showUnseenCount",e.throttle(V,36e5)))}),p&&Y(),c.on("focus",function(){l=!0,i&&i.close(),A!==-1&&(clearInterval(A),A=-1),o=[]}),h.currentBrowserNeedsPermission()&&(h.getUserPermission(),e.fire("util:ymstats",{name:"notifications_login_new_browser",tags:{agent:m}})),e.namespace("mail.ui").mailDesktopNotifications={isFromSameConv:_,init:X,onListRefresh:$,handleNotify:V,getRecepientList:D,openView:F,getTitle:I,getBody:q,getMosaicUrl:z,notify:U},f=!r.get(a)}var t=e.common.Utils,n=e.mail.ui.FolderUtils,r=e.mail.persist.MetaData,i=null,s=90,o=[],u="notification.mail",a="neo.pref.mailDesktopNotification.onboard",f=!1,l=!0,c=e.one("window"),h=e.mail.ui.desktopNotifications,p=t.features.enabled("importantNotifications"),d=t.features.enabled("peopleNotifications"),v=[],m=NeoConfig.browser&&NeoConfig.browser.split("_")[0],g=e.mail.controller.v3.settings.userSettings,y=t.features.enabled("isMetaDataMigrated")||NeoConfig.forceToV3UserSetting,b=p&&(y?g.getSync("attributes.web.importantNotification",!1):r.get("notificationType")==="important"),w=d&&(y?g.getSync("attributes.web.peopleNotification",!1):r.get("notificationType")==="people"),E,S,x,T=parseInt(t.settings.value("unseenNotifBlurLimit",Number.POSITIVE_INFINITY),10),N=parseInt(t.settings.value("unseenNotifShowLimit",Number.POSITIVE_INFINITY),10),C="NOTIF.LNT",k="NOTIF.WBT",L=t.settings.value("unseenNotifLogo","https://s.yimg.com/nq/a/img/desktop-notification-mail-100x100_1.png"),A=-1;NeoConfig.browser.toLowerCase().indexOf("safari")!==-1&&(s=45),h.browserSupportNotification()&&nt()},"1.0.0",{requires:["mail-ui-desktop-notifications","cookie","comms-utils","common-utils","xobni-utilities","mail-ui-folder-utils","ymma-stats","mail-persist-meta-data","mail-controller-v3-user-settings"]});
