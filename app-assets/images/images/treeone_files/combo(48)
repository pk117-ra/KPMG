YUI.add("common-ui-listview-ext",function(e){var t=e.Node,n=e.one,r=e.Lang,i=e.Array,s=e.common.Utils,o=e.Object,u="#",a="list",f="requestSize",l="pageSize",c="page",h="pageCount",p="loading",d=".",v="fidchange",m="setrange",g="selected",y="remove",b="display",w="update",E="renderComplete",S="list-stat:scrolRenderComplete",x="KEY",T="reverse",N="focused",C="tabIndex",k="height",L="prefetch",A="append",O=n("body"),M=n("#main"),_=e.common.ui.TimeChunk,D,P;e.mix(e.common.ui.ListView.prototype,{_selectRange:function(t,n,r,i){var s=this,o,u,a=s._getIndex;t._node&&(t=a(t)),r._node&&(r=a(r)),o=r;if(e.Lang.isNumber(r)){u=t<=o?-1:1;while(o!==t+u)s._selectByIndex(o,n,0,1,0,1),o+=u}i||s.set("selectionCount",s.selCount())},_updateItem:function(e,r){var i=this,s=r?i.stop()-1:e,o=i._model.valueAt(s),a=n(u+i._id(e)),f=i.get("activeItem"),l=i.get(N)&&f,c=a==i._lastSel,h=a==i._lastSS,p,v,m,g,y;if(o){i.fire("beforeItemUpdate"),NeoConfig.timeChunk&&(m=a&&a.previous(),g=NeoConfig.rearrangeMb&&m&&m.previous(),g&&g.hasClass("list-view-item-date-label")?o.addDateLabel=!1:m&&m.hasClass("list-view-item-date-label")?o.addDateLabel=!1:o.addDateLabel=!1),v=t.create(i._renderItem(o,s,i._sel[s],i._id(s)));if(r){if(l||c)p=a.next(d+i.ITEM_CLASS_NAME)||v;a.remove(),v&&i._srcNode.append(v)}else a&&a.replace(v),(l||c)&&f!==null&&i._getIndex(f)==e&&(p=v);i.fire("itemUpdate"),p&&i._focusItem(p),c&&(i._lastSel=p),h&&(i._lastSS=v),e==i.start()&&!f&&(y=v?v.one(".list-view-item"):null,y&&y.set(C,0),i._focusItem(y,1))}},_handleFailure:function(e){var t=this,n=t._srcNode;e.start!==0&&e.reason!=="prefetch"&&t.set("page",t.get("page")-1,{noupdate:1}),t.set("freeze",0)},_synclist:function(){var e=this;e._ss&&o.size(e._ss)&&(e._sel=e._model.indexesOf(e._ss)),e._sync(),e._lastSS=0,o.some(e._sel,function(t,n){return e._lastSel=e.getItemEl(n),1}),e._ss=0},_listchange:function(e){var t=this,n={},r=t._sel,i=t.checkmode,s,u,f,p,d,g,b,E;switch(e.subtype){case v:t.selCount()?(t._ss=o.values(r),t._synclist()):s=1;break;case m:t._synclist();break;case A:t._appendMessages(t.start(),t.stop());break;case L:break;case w:t._updateItem(e.index);break;case T:b=o.keys(r),d=b.length,f=t._model.get("length"),d==1?(g=b[0],E=g==f-g?g:f-g-1,t.set(c,Math.floor(E*1/t.get(l))),n[E]=r[b[0]]):t.set(c,0),t._clearSelect(1),t._sel=n,s=1,t.checkmode=i;break;case y:t._clearSelect(1),e.list&&e.list.length&&(u=t.getItemEl(e.list[0]))&&(t._set("activeItem",u),t._model.get(a).length===parseInt(e.list[0],10)?t._select(t.getItemEl(e.list[0]-1),1):t._select(u,1)),t.get("isActive")||t._set("activeItem",null),p=t.get(h),t.get(c)>=p&&t.set(c,p-1),s=1;break;default:s=1}s&&t._sync(!1,e.subtype)},_appendMessages:function(e,t){var n=this,r=n._model.get(a),i=0,s=n.get(l)*2,o=[],u=n._sel,f=n._srcNode,c=[],h=n.listObj?n.listObj.sortedColumn.sortOrder:"",p,d;if(D!==e||P!==t)n.setUpScrollSuccessRateStats(),D=e,P=t;if(n._r){n.fire("beforeRender"),n.fire("appendMessages"),n.set("showFocus",!1);for(d=e;d<t;d++)p=r[d],p?(c.push(r[d]),NeoConfig.timeChunk&&n.listObj.timeChunk&&(p.addDateLabel=_.addDateLabel(d,p,d>0?r[d-1]:"",h)),o.push(n._renderItem(p,d,u[d],n._id(d)))):i=1;f.one(".list-header-wrapper")&&f.one(".list-header-wrapper").remove(),i?(n._insertLoadingIndicator(),n._model.request(e,s,A)):f.all("."+n.PAGE_CLASS_NAME).size()*n.get(l)<e+1&&(n._removeLoadingIndicator(),f.appendChild('<div role = "presentation" class = "'+n.PAGE_CLASS_NAME+'">'+o.join("")+"</div>"),NeoConfig.timeChunk&&h==="down"&&_.addThisWeekLabel(),n.set("freeze",0),n.fire(E,{silent:!0}),n.fire(S))}},_insertLoadingIndicator:function(){var e=this,t=e._srcNode,n="listloading";t.one("#"+n)||t.appendChild("<div id="+n+' class="s-loader"></div>')},_removeLoadingIndicator:function(){var e=this,t=e._srcNode.one("#listloading");t&&t.remove().destroy(!0)},_renderVisiblePages:function(){var e=this,t=e._srcNode.get("scrollTop"),n=e.getCurrentPage(t),r,i=n-1<0?n:n-1;for(r=i;r<=n+1;r++)e.renderPage(r)},_sync:function(t,i){function u(){var r=this,o=r._model.get(a),u=0,c=r.stop(),h=t,p=r._srcNode,v=r._statusNode,m=r._maxLength,y=r._sel,b=r.get("activeItem"),w=r.get(l),S=e.Object.getValue(r,["listObj","fid"]),x=p.one("."+r.PAGE_CLASS_NAME),T=r.listObj?r.listObj.sortedColumn.sortOrder:"",C=r.get("page"),L=[],A=0,D,P,H,B,j,F,I,q,R,U,z;x&&(D=parseInt(x.getComputedStyle("height"),10)),H=r.getCurrentPage();if(r._r){r.fire("beforeRender"),r.set("showFocus",!1),b=r.get("activeItem");for(R=u;R<c;R++){U=o[R];if(!U){h=1,A=R;break}R%w===0&&(P=R/w,R!==0&&L.push("</div>"),!D||P>=H-1&&P<=H+1||P===C?L.push('<div role = "presentation" class = "'+r.PAGE_CLASS_NAME+'">'):L.push('<div role = "presentation" class = "'+r.PAGE_CLASS_NAME+'" style="height:'+D+'px">'));if(P>=H-1&&P<=H+1||P===C)NeoConfig.timeChunk&&r.listObj.timeChunk&&(U.addDateLabel=_.addDateLabel(R,U,R>0?o[R-1]:"",T)),L.push(r._renderItem(U,R,y[R],r._id(R)))}L.push("</div>"),h?c-A<200?(B=t?r.get(l)*2:r.get(l),j=Math.max(c-A,B)||r.get(f),r._model.request(A,j,i)):r.refresh(1):(v&&v.addClass("hidden"),e.common.Utils.features.enabled("predictiveSearch")?(F=e.Node.create(L.join("")),F&&r.smwNode&&(I=r.smwNode.one(".search-my-world"),S==="Inbox"&&I?(F.insert(r.smwNode,0),O.addClass("no-mb")):NeoConfig.moneyballEnabled&&O.removeClass("no-mb")),s.remove(p.get("children")),p.insert(F)):(s.remove(p.get("children")),p.setHTML(L.join(""))),NeoConfig.timeChunk&&T==="down"&&(n(".list-view-items").removeClass("etw").setAttribute("data-tc-label",""),_.addThisWeekLabel()),p.setStyle(k,"auto"),o.length&&(z=O&&O.hasClass("notoolbar")||M&&M.hasClass("withouttoolbar"),z||(i==="liststore"?e.fire("mbEvent:re-render"):(e.fire("mbEvent:rotate"),e.fire("rotateD2S")))),r.set("freeze",0)),r._maxLength=Math.max(m,p.get("offsetHeight")),t?r.set("activeItem",null):(q=r._parentNode,b=q.one(d+r.ITEM_CLASS_NAME+d+g)||q.one(d+r.ITEM_CLASS_NAME),b&&(r.set("activeItem",b),r.get(N)&&r._focusItem(b),r._lastSel=b)),i!=="liststore"&&(e.fire("mohawk:ready"),!NeoConfig.previewPanePref&&NeoConfig.onboarding.taskPanelEnabled&&s.features
.enabled("keyTasksPanel")&&e.mail.ui.Workspace.renderKeyTasksPanel(S,r._srcNode));if(!h){if(this.selCount()){if(r._lastSel)R=r._getIndex(r._lastSel);else for(R in y)break;r._lastSS=r._lastSel=r.getItemEl(R)}i!=="liststore"&&r._prefetch(),r.fire(E)}s.features.enabled("timeChunk")&&r.updateAnchoredLabel(!0,!1,i,S)}}var o=this;o._tmSync&&o._tmSync.cancel(),o._tmSync=r.later(0,o,u)},_resetScrollTop:function(){var e=this._parentNode.one(d+this.LIST_CLASS_NAME);e.set("scrollTop",0)},_setStatus:function(t){var n=this,r=n._statusNode,i=!1,s="";t=t||"",i=t.hideLoader||!1,s=t.tmpl||t,!r&&n._parentNode&&(r=e.Node.create('<div role="'+n.STATUS_ROLE+'" tabindex="-1" class="status '+n.STATUS_CLASS_NAME+'"></div>'),r.addClass("hidden"),n._statusNode=r,n._parentNode.one("#lv-statuses-container").prepend(r),n._maxLength=Math.max(500,n._srcNode.get("offsetHeight"))),r&&(i?r.removeClass(p):r.addClass(p),s==="loading-icon"&&(s='<div class="s-loader"></div>'),n._status=s||"",s&&n.get("focused")&&r.focus(),r.setContent(n._status),r.removeClass("hidden"),n._srcNode.setContent(""),n._srcNode.setStyle(k,n._maxLength+"px"))},_prefetch:function(){var e=this,t=e._model.get(a),n=e.stop(),r=Math.min(t.length,n+e.get(l)-1);n<t.length&&!t[r]&&e._model.request(n,e.get(l)*2,L)},_setSelection:function(e){function f(){s=t._model.get(a),i.each(e,function(e){u[e]=s[e]||1,n=e}),t._sel=u}var t=this,n,s=t._model.get(a),u={};t._clearSelect(),e=e?r.isObject(e)?o.keys(e):r.isArray(e)?e:[e]:[],f(),n&&(s[n]||t.once(E,f,t),t.set("page",Math.floor(n/t.get(l)),{noupdate:1})),t._sync()},_blur:function(){return},_moveToItem:function(e,t){var n=this,r=!0,i={188:1,190:1};if(e){n._focusItem(e);if(!t.metaKey&&!t.ctrlKey||t.ctrlKey&&i[t.keyCode]){t.shiftKey&&n._lastSel?n._select(n._lastSel,0,e,1,0,!0):n._clearSelect(),n._lastSel=e,n._select(e,1,n._lastSS,t.shiftKey);if(n.selCount()===1||!t.shiftKey)n._lastSS=e;r=!1}n.set("showFocus",r)}t.halt&&t.halt()},_keydown:function(t){var n=this,r=n.get("activeItem"),i,s,o=d+n.ITEM_CLASS_NAME,u,a=n._getListItem(t,1),f=a?a.hasClass(g):0,l,c=0,h;h=r?n._getIndex(n.get("activeItem")):n._lastSel?n._getIndex(n._lastSel):c,r||(r=n.getItemEl(h));if(!r||!n._srcNode.contains(r)){var p=Math.floor(h/n.get("pageSize"));n.renderPage(p,n._srcNode.all("."+n.PAGE_CLASS_NAME).item(p)),r=n.getItemEl(h)}n._set("activeItem",r);switch(t.keyCode){case 38:case 40:e.fire("HoverCard:hideHoverCard"),t.altKey?i=n.getItemEl(t.keyCode===38?n.start():n.stop()-1):r&&(l=n._getIndex(r),i=n.selCount()?t.keyCode===38?n.getItemEl(l-1):n.getItemEl(l+1):r,t.keyCode===38&&!n.selCount()&&(s=i,i=i.previous(o),i||(i=s)),!t.shiftKey&&!t.metaKey&&!t.ctrlKey&&n._lastSel&&n._lastSel!=r&&(i=r)),i&&(!t.shiftKey&&!t.metaKey&&!t.ctrlKey&&n.selCount()&&n._clearSelect(),n._moveToItem(i,t));break;case 32:if(t.metaKey||t.ctrlKey||t.altKey)return;if(!n._checkbox(t)){if(n._isFormControl(t))return;t.shiftKey?n._selectRange(n._lastSS,!n._sel[n._getIndex(r)],a):(f&&!n.checkmode?u=1:u=!f,n._select(a,u,0,1),n._lastSel=n._lastSS=u?a:0),t.halt()}break;case 13:n.selCount()===1&&n.fire("command",{e:t,item:n._model.valueAt(n._getIndex(r))});break;case 188:t.ctrlKey&&r&&(i=n.selCount()?r.previous(o):r,n._moveToItem(i,t));break;case 190:t.ctrlKey&&r&&(i=n.selCount()?r.next(o):r,n._moveToItem(i,t));break;case 36:n.scrollToTop(),t.halt();break;case 33:if(t.ctrlKey)break;n.pageUpOrDown(!0),t.halt();break;case 34:if(t.ctrlKey)break;n.pageUpOrDown(!1),t.halt()}},_isCheckboxBorder:function(e){var t=e.target,n,r=0,i=0,s,o;if(t.hasClass("list-view-item"))return NeoConfig.hoverPreview||(o=t.one("div.info"),o&&(r=o.get("offsetWidth"))),s=t.one("input"),s&&(i=s.get("offsetWidth")),n=t.getX()||0,e.clientX>n&&e.clientX<n+i+r},getPageIndex:function(e){var t=this,n=t.get("page"),r=t.get("pageSize"),i=t._getListItem(e,1),s=t._getIndex(i),o=s-n*r;return o},setUpScrollSuccessRateStats:function(){var t=this;t.scrolRenderCompleteHandler&&t.scrolRenderCompleteHandler.detach(),e.fire("stat:feature_invoke",{message:"UI_LIST_MESSAGE_SCROLL_START_SUCCESS",feature_group:"LIST"}),t.scrolRenderCompleteHandler=t.once(S,function(){e.fire("stat:feature_complete",{message:"UI_LIST_MESSAGE_SCROLL_COMPLETE_SUCCESS",feature_group:"LIST"})})}},1),e.mix(e.common.ui.ListModel.prototype,{setRange:function(e,t,n){var r=this,i=t.length,s=r.get(a),o=s.length;n=n||m,t=t||[],r._refresh&&(s=[],s.length=o,r._refresh=0);while(i--)s[e+i]=t[i];r.set(a,s,{subtype:n,start:e})},update:function(e,t){var n=this.get(a);n[e]=t,this.set(a,n,{subtype:w,index:e})},remove:function(e){var t=this,n=r.isArray(e)?i(e).sort(i.numericSort):o.keys(e),s=n.length,u=t.get(a);n=i(n).sort(i.numericSort);while(s--)u.splice(n[s],1);t.set(a,u,{subtype:y,list:n})},reverse:function(){var e=this,t=e.get(a);t.reverse(),e.set(a,t,{subtype:T})},indexesOf:function(e,t){var n,s=this,o,u=s.get(x),f=s.get(a),l={},c={},h=f.length;e=r.isArray(e)?e:[e],i.each(e,function(e){l[e[u]]=e});for(n=0;n<h;n++){o=f[n];if(o=f[n]&&l[o[u]])c[n]=o}return t&&t(c),c}},1)},"1.0.0",{requires:["common-ui-listview","mail-common-utils-features","common-utils"]});
